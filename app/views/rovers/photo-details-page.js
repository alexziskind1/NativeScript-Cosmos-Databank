"use strict";
var observable_1 = require("data/observable");
var frame_1 = require("ui/frame");
var utils = require("utils/utils");
var enums = require("ui/enums");
var fileSystem = require("file-system");
var imageSource = require("image-source");
var application = require("application");
var SocialShare = require("nativescript-social-share");
if (application.android) {
    var toast = require("nativescript-toast");
}
var viewModel;
var shareButtonAndroid;
var page;
var shareButton;
var saveButton;
var desktopButton;
var iosImage;
var currentImage;
var currentSavedPath;
function onPageLoaded(args) {
    page = args.object;
    shareButton = page.getViewById("btn-shar");
    saveButton = page.getViewById("btn-save");
    desktopButton = page.getViewById("btn-desk");
    if (application.ios) {
        iosImage = page.getViewById("ios-image");
    }
    var navContext = page.navigationContext;
    viewModel = new observable_1.Observable();
    viewModel.set("contextItem", navContext["tappedItem"]);
    viewModel.set("isItemVisible", false);
    page.bindingContext = viewModel;
}
exports.onPageLoaded = onPageLoaded;
function goBack(args) {
    frame_1.topmost().goBack();
}
exports.goBack = goBack;
var http = require("http");
function onFinalImageSet(args) {
    var drawee = args.object;
    console.log("drawee.imageUri:" + drawee.imageUri);
    http.getFile(drawee.imageUri).then(function (res) {
        //currentImage = res
        console.log("res.path: " + res.path);
        try {
            currentImage = imageSource.fromFile(res.path);
            console.log(currentImage);
        }
        catch (error) {
            console.log(error);
        }
    }).catch(function (err) {
        console.log("http.getImage error" + err);
    });
    imageSource.fromUrl(drawee.imageUri)
        .then(function (res) {
        currentImage = res;
        viewModel.set("isItemVisible", true);
        shareButton.on("tap", function (params) {
            SocialShare.shareImage(res, "Mars Rovers - Cosmos DataBank mobile App");
        });
    }).catch(function (err) {
        console.log(err);
    });
}
exports.onFinalImageSet = onFinalImageSet;
function saveFile(res) {
    var name = viewModel.get("contextItem").id + "" + viewModel.get("contextItem").earthDate;
    var fileName = name + ".jpeg";
    if (application.android) {
        var androidDownloadsPath = android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_DOWNLOADS).toString();
        var cosmosFolderPath = fileSystem.path.join(androidDownloadsPath, "CosmosDataBank");
    }
    else if (application.ios) {
        var iosDownloadPath = fileSystem.knownFolders.documents();
        // tslint:disable-next-line:no-shadowed-variable
        var cosmosFolderPath = fileSystem.path.join(iosDownloadPath.path, "CosmosDataBank");
    }
    var folder = fileSystem.Folder.fromPath(cosmosFolderPath);
    var path = fileSystem.path.join(cosmosFolderPath, fileName);
    var exists = fileSystem.File.exists(path);
    if (!exists) {
        var saved = res.saveToFile(path, enums.ImageFormat.jpeg);
    }
    currentSavedPath = path;
}
function onSaveImage(args) {
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            saveFile(res);
        }).catch(function (err) {
            // console.log(err);
        });
    }
    else if (application.android) {
        saveFile(currentImage);
        toast.makeText("Photo saved in /Downloads/CosmosDataBank/").show();
    }
}
exports.onSaveImage = onSaveImage;
function onSetWallpaper(args) {
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            currentImage = res; // TODO : set wallpaper for iOS
        }).catch(function (err) {
            // console.log(err);
        });
        ;
    }
    else if (application.android) {
        saveFile(currentImage);
        var wallpaperManager = android.app.WallpaperManager.getInstance(utils.ad.getApplicationContext());
        try {
            var imageToSet = imageSource.fromFile(currentSavedPath);
            wallpaperManager.setBitmap(imageToSet.android);
        }
        catch (error) {
        }
        toast.makeText("Wallpaper Set!").show();
    }
}
exports.onSetWallpaper = onSetWallpaper;
function onShare(args) {
    if (application.android) {
        SocialShare.shareImage(currentImage, "Mars Rovers");
    }
    else if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            SocialShare.shareImage(res);
        }).catch(function (err) {
            // console.log(err);
        });
    }
}
exports.onShare = onShare;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGhvdG8tZGV0YWlscy1wYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGhvdG8tZGV0YWlscy1wYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSw4Q0FBd0Q7QUFHeEQsa0NBQW1DO0FBR25DLG1DQUFxQztBQUNyQyxnQ0FBbUM7QUFDbkMsd0NBQTJDO0FBQzNDLDBDQUE2QztBQUM3Qyx5Q0FBNEM7QUFFNUMsdURBQXlEO0FBRXpELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3RCLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFFRCxJQUFJLFNBQVMsQ0FBQztBQUNkLElBQUksa0JBQWtCLENBQUM7QUFFdkIsSUFBSSxJQUFVLENBQUM7QUFDZixJQUFJLFdBQW1CLENBQUM7QUFDeEIsSUFBSSxVQUFrQixDQUFDO0FBQ3ZCLElBQUksYUFBcUIsQ0FBQztBQUUxQixJQUFJLFFBQWUsQ0FBQztBQUNwQixJQUFJLFlBQXFDLENBQUM7QUFFMUMsSUFBSSxnQkFBd0IsQ0FBQztBQUU3QixzQkFBNkIsSUFBZTtJQUN4QyxJQUFJLEdBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUV6QixXQUFXLEdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuRCxVQUFVLEdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNsRCxhQUFhLEdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUVyRCxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNsQixRQUFRLEdBQVUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDO0lBQ3hDLFNBQVMs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QyxDQUFDO1FBQ3RCLFdBQVcsQ0FBQyxVQUFVLENBQUMsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekIsV0FBVyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO2FBQzVCLElBQUksQ0FBQyxVQUFBLEdBQUc7WUFDTCxXQUFXLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFBLEdBQUc7WUFDUixvQkFBb0I7UUFDeEIsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0FBQ0wsQ0FBQztBQVhELDBCQVdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHJhd2VyT3Zlck5hdmlnYXRpb25Nb2RlbCB9IGZyb20gXCIuLi8uLi92aWV3LW1vZGVscy9kcmF3ZXItb3Zlci1uYXZpZ2F0aW9uLW1vZGVsXCI7XHJcbmltcG9ydCB7IEV2ZW50RGF0YSwgT2JzZXJ2YWJsZSB9IGZyb20gXCJkYXRhL29ic2VydmFibGVcIjtcclxuaW1wb3J0IHsgUGFnZSB9IGZyb20gXCJ1aS9wYWdlXCI7XHJcbmltcG9ydCB7IEJ1dHRvbiB9IGZyb20gXCJ1aS9idXR0b25cIjtcclxuaW1wb3J0IHsgdG9wbW9zdCB9IGZyb20gXCJ1aS9mcmFtZVwiO1xyXG5pbXBvcnQgeyBJbWFnZSB9IGZyb20gXCJ1aS9pbWFnZVwiO1xyXG5pbXBvcnQgeyBHZXN0dXJlVHlwZXMsIEdlc3R1cmVFdmVudERhdGEgfSBmcm9tIFwidWkvZ2VzdHVyZXNcIjtcclxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSBcInV0aWxzL3V0aWxzXCI7XHJcbmltcG9ydCBlbnVtcyA9IHJlcXVpcmUoXCJ1aS9lbnVtc1wiKTtcclxuaW1wb3J0IGZpbGVTeXN0ZW0gPSByZXF1aXJlKFwiZmlsZS1zeXN0ZW1cIik7XHJcbmltcG9ydCBpbWFnZVNvdXJjZSA9IHJlcXVpcmUoXCJpbWFnZS1zb3VyY2VcIik7XHJcbmltcG9ydCBhcHBsaWNhdGlvbiA9IHJlcXVpcmUoXCJhcHBsaWNhdGlvblwiKTtcclxuaW1wb3J0IHsgRnJlc2NvRHJhd2VlLCBGaW5hbEV2ZW50RGF0YSB9IGZyb20gXCJuYXRpdmVzY3JpcHQtZnJlc2NvXCI7XHJcbmltcG9ydCAqIGFzIFNvY2lhbFNoYXJlIGZyb20gXCJuYXRpdmVzY3JpcHQtc29jaWFsLXNoYXJlXCI7XHJcblxyXG5pZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xyXG4gICAgdmFyIHRvYXN0ID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC10b2FzdFwiKTtcclxufVxyXG5cclxubGV0IHZpZXdNb2RlbDtcclxudmFyIHNoYXJlQnV0dG9uQW5kcm9pZDtcclxuXHJcbmxldCBwYWdlOiBQYWdlO1xyXG5sZXQgc2hhcmVCdXR0b246IEJ1dHRvbjtcclxubGV0IHNhdmVCdXR0b246IEJ1dHRvbjtcclxubGV0IGRlc2t0b3BCdXR0b246IEJ1dHRvbjtcclxuXHJcbmxldCBpb3NJbWFnZTogSW1hZ2U7XHJcbmxldCBjdXJyZW50SW1hZ2U6IGltYWdlU291cmNlLkltYWdlU291cmNlO1xyXG5cclxudmFyIGN1cnJlbnRTYXZlZFBhdGg6IHN0cmluZztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvblBhZ2VMb2FkZWQoYXJnczogRXZlbnREYXRhKSB7XHJcbiAgICBwYWdlID0gPFBhZ2U+YXJncy5vYmplY3Q7XHJcblxyXG4gICAgc2hhcmVCdXR0b24gPSA8QnV0dG9uPnBhZ2UuZ2V0Vmlld0J5SWQoXCJidG4tc2hhclwiKTtcclxuICAgIHNhdmVCdXR0b24gPSA8QnV0dG9uPnBhZ2UuZ2V0Vmlld0J5SWQoXCJidG4tc2F2ZVwiKTtcclxuICAgIGRlc2t0b3BCdXR0b24gPSA8QnV0dG9uPnBhZ2UuZ2V0Vmlld0J5SWQoXCJidG4tZGVza1wiKTtcclxuXHJcbiAgICBpZiAoYXBwbGljYXRpb24uaW9zKSB7XHJcbiAgICAgICAgaW9zSW1hZ2UgPSA8SW1hZ2U+cGFnZS5nZXRWaWV3QnlJZChcImlvcy1pbWFnZVwiKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgbmF2Q29udGV4dCA9IHBhZ2UubmF2aWdhdGlvbkNvbnRleHQ7XHJcbiAgICB2aWV3TW9kZWwgPSBuZXcgT2JzZXJ2YWJsZSgpO1xyXG4gICAgdmlld01vZGVsLnNldChcImNvbnRleHRJdGVtXCIsIG5hdkNvbnRleHRbXCJ0YXBwZWRJdGVtXCJdKTtcclxuICAgIHZpZXdNb2RlbC5zZXQoXCJpc0l0ZW1WaXNpYmxlXCIsIGZhbHNlKTtcclxuXHJcbiAgICBwYWdlLmJpbmRpbmdDb250ZXh0ID0gdmlld01vZGVsO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ29CYWNrKGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gICAgdG9wbW9zdCgpLmdvQmFjaygpO1xyXG59XHJcblxyXG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gb25GaW5hbEltYWdlU2V0KGFyZ3M6IEZpbmFsRXZlbnREYXRhKSB7XHJcbiAgICB2YXIgZHJhd2VlID0gYXJncy5vYmplY3QgYXMgRnJlc2NvRHJhd2VlO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKFwiZHJhd2VlLmltYWdlVXJpOlwiICsgZHJhd2VlLmltYWdlVXJpKTtcclxuXHJcbiAgICBodHRwLmdldEZpbGUoZHJhd2VlLmltYWdlVXJpKS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgLy9jdXJyZW50SW1hZ2UgPSByZXNcclxuXHJcbiAgICAgICAgY29uc29sZS5sb2coXCJyZXMucGF0aDogXCIgKyByZXMucGF0aCk7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY3VycmVudEltYWdlID0gaW1hZ2VTb3VyY2UuZnJvbUZpbGUocmVzLnBhdGgpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjdXJyZW50SW1hZ2UpXHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiaHR0cC5nZXRJbWFnZSBlcnJvclwiICsgZXJyKTtcclxuICAgIH0pO1xyXG5cclxuXHJcbiAgICBpbWFnZVNvdXJjZS5mcm9tVXJsKGRyYXdlZS5pbWFnZVVyaSlcclxuICAgICAgICAudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICBjdXJyZW50SW1hZ2UgPSByZXM7XHJcbiAgICAgICAgICAgIHZpZXdNb2RlbC5zZXQoXCJpc0l0ZW1WaXNpYmxlXCIsIHRydWUpO1xyXG5cclxuICAgICAgICAgICAgc2hhcmVCdXR0b24ub24oXCJ0YXBcIiwgZnVuY3Rpb24gKHBhcmFtczogR2VzdHVyZUV2ZW50RGF0YSkge1xyXG4gICAgICAgICAgICAgICAgU29jaWFsU2hhcmUuc2hhcmVJbWFnZShyZXMsIFwiTWFycyBSb3ZlcnMgLSBDb3Ntb3MgRGF0YUJhbmsgbW9iaWxlIEFwcFwiKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTsgXHJcbiAgICAgICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNhdmVGaWxlKHJlczogaW1hZ2VTb3VyY2UuSW1hZ2VTb3VyY2UpIHtcclxuICAgIHZhciBuYW1lID0gdmlld01vZGVsLmdldChcImNvbnRleHRJdGVtXCIpLmlkICsgXCJcIiArIHZpZXdNb2RlbC5nZXQoXCJjb250ZXh0SXRlbVwiKS5lYXJ0aERhdGU7XHJcblxyXG4gICAgdmFyIGZpbGVOYW1lID0gbmFtZSArIFwiLmpwZWdcIjtcclxuXHJcbiAgICBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xyXG4gICAgICAgIHZhciBhbmRyb2lkRG93bmxvYWRzUGF0aCA9IGFuZHJvaWQub3MuRW52aXJvbm1lbnQuZ2V0RXh0ZXJuYWxTdG9yYWdlUHVibGljRGlyZWN0b3J5KFxyXG4gICAgICAgICAgICBhbmRyb2lkLm9zLkVudmlyb25tZW50LkRJUkVDVE9SWV9ET1dOTE9BRFMpLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgdmFyIGNvc21vc0ZvbGRlclBhdGggPSBmaWxlU3lzdGVtLnBhdGguam9pbihhbmRyb2lkRG93bmxvYWRzUGF0aCwgXCJDb3Ntb3NEYXRhQmFua1wiKTtcclxuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uaW9zKSB7XHJcbiAgICAgICAgdmFyIGlvc0Rvd25sb2FkUGF0aCA9IGZpbGVTeXN0ZW0ua25vd25Gb2xkZXJzLmRvY3VtZW50cygpO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zaGFkb3dlZC12YXJpYWJsZVxyXG4gICAgICAgIHZhciBjb3Ntb3NGb2xkZXJQYXRoID0gZmlsZVN5c3RlbS5wYXRoLmpvaW4oaW9zRG93bmxvYWRQYXRoLnBhdGgsIFwiQ29zbW9zRGF0YUJhbmtcIik7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIGZvbGRlciA9IGZpbGVTeXN0ZW0uRm9sZGVyLmZyb21QYXRoKGNvc21vc0ZvbGRlclBhdGgpO1xyXG4gICAgdmFyIHBhdGggPSBmaWxlU3lzdGVtLnBhdGguam9pbihjb3Ntb3NGb2xkZXJQYXRoLCBmaWxlTmFtZSk7XHJcbiAgICB2YXIgZXhpc3RzID0gZmlsZVN5c3RlbS5GaWxlLmV4aXN0cyhwYXRoKTtcclxuXHJcbiAgICBpZiAoIWV4aXN0cykge1xyXG4gICAgICAgIHZhciBzYXZlZCA9IHJlcy5zYXZlVG9GaWxlKHBhdGgsIGVudW1zLkltYWdlRm9ybWF0LmpwZWcpO1xyXG4gICAgfVxyXG5cclxuICAgIGN1cnJlbnRTYXZlZFBhdGggPSBwYXRoO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gb25TYXZlSW1hZ2UoYXJnczogRXZlbnREYXRhKSB7XHJcblxyXG4gICAgaWYgKGFwcGxpY2F0aW9uLmlvcykge1xyXG4gICAgICAgIGltYWdlU291cmNlLmZyb21VcmwoaW9zSW1hZ2Uuc3JjKVxyXG4gICAgICAgICAgICAudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgc2F2ZUZpbGUocmVzKTtcclxuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XHJcbiAgICAgICAgc2F2ZUZpbGUoY3VycmVudEltYWdlKTtcclxuICAgICAgICB0b2FzdC5tYWtlVGV4dChcIlBob3RvIHNhdmVkIGluIC9Eb3dubG9hZHMvQ29zbW9zRGF0YUJhbmsvXCIpLnNob3coKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uU2V0V2FsbHBhcGVyKGFyZ3M6IEV2ZW50RGF0YSkge1xyXG5cclxuICAgIGlmIChhcHBsaWNhdGlvbi5pb3MpIHtcclxuICAgICAgICBpbWFnZVNvdXJjZS5mcm9tVXJsKGlvc0ltYWdlLnNyYylcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRJbWFnZSA9IHJlczsgLy8gVE9ETyA6IHNldCB3YWxscGFwZXIgZm9yIGlPU1xyXG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgfSk7IDtcclxuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xyXG5cclxuICAgICAgICBzYXZlRmlsZShjdXJyZW50SW1hZ2UpO1xyXG5cclxuICAgICAgICB2YXIgd2FsbHBhcGVyTWFuYWdlciA9IGFuZHJvaWQuYXBwLldhbGxwYXBlck1hbmFnZXIuZ2V0SW5zdGFuY2UodXRpbHMuYWQuZ2V0QXBwbGljYXRpb25Db250ZXh0KCkpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHZhciBpbWFnZVRvU2V0ID0gaW1hZ2VTb3VyY2UuZnJvbUZpbGUoY3VycmVudFNhdmVkUGF0aCk7XHJcbiAgICAgICAgICAgIHdhbGxwYXBlck1hbmFnZXIuc2V0Qml0bWFwKGltYWdlVG9TZXQuYW5kcm9pZCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdG9hc3QubWFrZVRleHQoXCJXYWxscGFwZXIgU2V0IVwiKS5zaG93KCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvblNoYXJlKGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcclxuICAgICAgICBTb2NpYWxTaGFyZS5zaGFyZUltYWdlKGN1cnJlbnRJbWFnZSwgXCJNYXJzIFJvdmVyc1wiKTtcclxuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uaW9zKSB7XHJcbiAgICAgICAgaW1hZ2VTb3VyY2UuZnJvbVVybChpb3NJbWFnZS5zcmMpXHJcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBTb2NpYWxTaGFyZS5zaGFyZUltYWdlKHJlcyk7XHJcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG4iXX0=