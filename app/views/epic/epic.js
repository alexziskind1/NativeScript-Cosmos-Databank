"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var application = require("application");
var fileSystem = require("file-system");
var imageSource = require("image-source");
var utils = require("utils/utils");
var SocialShare = require("nativescript-social-share");
if (application.android) {
    var toast = require("nativescript-toast");
}
var epic_model_1 = require("../../view-models/epic/epic-model");
var epicViewModel = new epic_model_1.EpicViewModel();
var page;
var shareButton;
var saveButton;
var desktopButton;
var iosImage;
var currentImage;
var currentSavedPath;
function onPageLoaded(args) {
    page = args.object;
}
exports.onPageLoaded = onPageLoaded;
function onScrollSwipe(args) {
    // if (args.direction === 1) {
    //     previousDate();
    // } else if (args.direction === 2) {
    //     nextDate();
    // }   
}
exports.onScrollSwipe = onScrollSwipe;
function onPageNavigatedTo(args) {
    page = args.object;
    var pageContainer = page.getViewById("pageContainer");
    shareButton = page.getViewById("btn-share");
    saveButton = page.getViewById("btn-save");
    desktopButton = page.getViewById("btn-desk");
    if (application.android) {
        setButtonsOpacity(0.2);
        setUserInteraction(false);
    }
    if (application.ios) {
        iosImage = page.getViewById("ios-image");
    }
    if (!epicViewModel.get("dataItem")) {
        epicViewModel.initDataItems();
    }
    pageContainer.bindingContext = epicViewModel;
}
exports.onPageNavigatedTo = onPageNavigatedTo;
function onSaveImage(args) {
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            saveFile(res);
        }).catch(function (err) {
            // console.log(err.stack);
        });
    }
    else if (application.android) {
        saveFile(currentImage);
        toast.makeText("Photo saved in /Downloads/CosmosDataBank/").show();
    }
}
exports.onSaveImage = onSaveImage;
function onSetWallpaper(args) {
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            currentImage = res; // TODO : set wallpaper for iOS
        }).catch(function (err) {
            // console.log(err.stack);
        });
        ;
    }
    else if (application.android) {
        saveFile(currentImage);
        var wallpaperManager = application.android.nativeApp.WallpaperManager.getInstance(utils.ad.getApplicationContext());
        try {
            var imageToSet = imageSource.fromFile(currentSavedPath);
            wallpaperManager.setBitmap(imageToSet.android);
        }
        catch (error) {
            // console.log(error.stack);
        }
        toast.makeText("Wallpaper Set!").show();
    }
}
exports.onSetWallpaper = onSetWallpaper;
function onShare(args) {
    if (application.android) {
        SocialShare.shareImage(currentImage, "NASA EPIC");
    }
    else if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            SocialShare.shareImage(res);
        }).catch(function (err) {
            // console.log(err.stack);
        });
    }
}
exports.onShare = onShare;
function previousDate() {
    // if (application.android) {
    //     setButtonsOpacity(0.2);
    //     setUserInteraction(false);
    // }
    // // TODO: add check if the date is not too far in the past (check first EPIC date)
    // var currentDate = epicViewModel.get("selectedDate");
    // currentDate.setDate(currentDate.getDate()-1);
    // epicViewModel.set("selectedDate", currentDate);
    // epicViewModel.initDataItems(); 
}
exports.previousDate = previousDate;
function nextDate() {
    // if (application.android) {
    //     setButtonsOpacity(0.2);
    //     setUserInteraction(false);
    // }
    // var currentDate = epicViewModel.get("selectedDate");
    // if (currentDate >= new Date()) {
    //     if (application.android) {
    //         toast.makeText("Can not load photos from future!").show();
    //     }
    // } else {
    //     currentDate.setDate(currentDate.getDate()+1);
    //     epicViewModel.set("selectedDate", currentDate);
    //     epicViewModel.initDataItems(); 
    // }
}
exports.nextDate = nextDate;
function onSubmit(args) {
    console.log("on submit ");
}
exports.onSubmit = onSubmit;
function onFinalImageSet(args) {
    var drawee = args.object;
    imageSource.fromUrl(drawee.imageUri)
        .then(function (res) {
        currentImage = res;
        saveButton.animate({ opacity: 0.2, rotate: 360 })
            .then(function (resu) { return saveButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
            .then(function (resul) { return saveButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
        desktopButton.animate({ opacity: 0.2, rotate: 360 })
            .then(function (resu) { return desktopButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
            .then(function (resul) { return desktopButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
        shareButton.animate({ opacity: 0.2, rotate: 360 })
            .then(function (resu) { return shareButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
            .then(function (resul) { return shareButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
        setUserInteraction(true);
    }).catch(function (err) {
        // console.log(err.stack);
    });
}
exports.onFinalImageSet = onFinalImageSet;
function saveFile(res) {
    var url = epicViewModel.get("dataItem").url;
    var fileName = url.substring(url.lastIndexOf("/") + 1);
    var n = fileName.indexOf(".");
    fileName = fileName.substring(0, n !== -1 ? n : fileName.length) + ".jpeg";
    if (application.android) {
        // tslint:disable-next-line:max-line-length
        var androidDownloadsPath = application.android.nativeApp.os.Environment.getExternalStoragePublicDirectory(application.android.nativeApp.os.Environment.DIRECTORY_DOWNLOADS).toString();
        var cosmosFolderPath = fileSystem.path.join(androidDownloadsPath, "CosmosDataBank");
    }
    else if (application.ios) {
        // TODO :  this works - but where are the images ?
        var iosDownloadPath = fileSystem.knownFolders.documents();
        // tslint:disable-next-line:no-shadowed-variable
        var cosmosFolderPath = fileSystem.path.join(iosDownloadPath.path, "CosmosDataBank");
    }
    var folder = fileSystem.Folder.fromPath(cosmosFolderPath);
    var path = fileSystem.path.join(cosmosFolderPath, fileName);
    var exists = fileSystem.File.exists(path);
    if (!exists) {
        var saved = res.saveToFile(path, "jpeg");
    }
    currentSavedPath = path;
}
exports.saveFile = saveFile;
function onIosShare() {
    console.log("iOS share tapped! 1");
    console.log(iosImage.src);
    imageSource.fromUrl(iosImage.src)
        .then(function (res) {
        SocialShare.shareImage(res);
    }).catch(function (err) {
        // console.log(err.sstack);
    });
}
exports.onIosShare = onIosShare;
function formatDate(date) {
    var d = new Date(date), month = "" + (d.getMonth() + 1), day = "" + d.getDate(), year = d.getFullYear();
    if (month.length < 2) {
        month = "0" + month;
    }
    if (day.length < 2) {
        day = "0" + day;
    }
    return [year, month, day].join("-");
}
function setUserInteraction(state) {
    shareButton.isUserInteractionEnabled = state;
    saveButton.isUserInteractionEnabled = state;
    desktopButton.isUserInteractionEnabled = state;
}
function setButtonsOpacity(value) {
    saveButton.opacity = value;
    desktopButton.opacity = value;
    shareButton.opacity = value;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXBpYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImVwaWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFXQSx5Q0FBNEM7QUFJNUMsd0NBQTJDO0FBQzNDLDBDQUE2QztBQUU3QyxtQ0FBcUM7QUFJckMsdURBQXlEO0FBRXpELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3RCLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFFRCxnRUFBNEU7QUFDNUUsSUFBSSxhQUFhLEdBQUcsSUFBSSwwQkFBYSxFQUFFLENBQUM7QUFFeEMsSUFBSSxJQUFVLENBQUM7QUFDZixJQUFJLFdBQW1CLENBQUM7QUFDeEIsSUFBSSxVQUFrQixDQUFDO0FBQ3ZCLElBQUksYUFBcUIsQ0FBQztBQUMxQixJQUFJLFFBQWUsQ0FBQztBQUNwQixJQUFJLFlBQXFDLENBQUM7QUFFMUMsSUFBSSxnQkFBd0IsQ0FBQztBQUU3QixzQkFBNkIsSUFBZTtJQUN4QyxJQUFJLEdBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUM3QixDQUFDO0FBRkQsb0NBRUM7QUFFRCx1QkFBOEIsSUFBMkI7SUFDckQsOEJBQThCO0lBQzlCLHNCQUFzQjtJQUN0QixxQ0FBcUM7SUFDckMsa0JBQWtCO0lBQ2xCLE9BQU87QUFDWCxDQUFDO0FBTkQsc0NBTUM7QUFFRCwyQkFBa0MsSUFBZTtJQUM3QyxJQUFJLEdBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN6QixJQUFJLGFBQWEsR0FBZ0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUVuRSxXQUFXLEdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRCxVQUFVLEdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNsRCxhQUFhLEdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxV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QUFDLFVBQUEsSUFBSSxJQUFNLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzFGLElBQUksQ0FBQyxVQUFBLEtBQUssSUFBTSxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRS9GLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQzthQUMvQyxJQUFJLENBQUMsVUFBQSxJQUFJLElBQU0sTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDN0YsSUFBSSxDQUFDLFVBQUEsS0FBSyxJQUFNLE1BQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFbEcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDO2FBQzdDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBTSxNQUFNLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMs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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudERhdGEsIFByb3BlcnR5Q2hhbmdlRGF0YSB9IGZyb20gXCJkYXRhL29ic2VydmFibGVcIjtcbmltcG9ydCB7IEJ1dHRvbiB9IGZyb20gXCJ1aS9idXR0b25cIjtcbmltcG9ydCB7IEltYWdlIH0gZnJvbSBcInVpL2ltYWdlXCI7XG5pbXBvcnQgeyBHZXN0dXJlVHlwZXMsIEdlc3R1cmVFdmVudERhdGEsIFN3aXBlR2VzdHVyZUV2ZW50RGF0YSB9IGZyb20gXCJ1aS9nZXN0dXJlc1wiO1xuaW1wb3J0IHsgR3JpZExheW91dCB9IGZyb20gXCJ1aS9sYXlvdXRzL2dyaWQtbGF5b3V0XCI7XG5pbXBvcnQgeyBMaXN0VmlldyB9IGZyb20gXCJ1aS9saXN0LXZpZXdcIjtcbmltcG9ydCB7IFBhZ2UgfSBmcm9tIFwidWkvcGFnZVwiO1xuaW1wb3J0IHsgU2Nyb2xsVmlldyB9IGZyb20gXCJ1aS9zY3JvbGwtdmlld1wiO1xuaW1wb3J0IHsgU3RhY2tMYXlvdXQgfSBmcm9tIFwidWkvbGF5b3V0cy9zdGFjay1sYXlvdXRcIjtcbmltcG9ydCB7IHRvcG1vc3QgfSBmcm9tIFwidWkvZnJhbWVcIjtcblxuaW1wb3J0IGFwcGxpY2F0aW9uID0gcmVxdWlyZShcImFwcGxpY2F0aW9uXCIpO1xuaW1wb3J0IGNvbG9yID0gcmVxdWlyZShcImNvbG9yXCIpO1xuaW1wb3J0IGRpYWxvZ3MgPSByZXF1aXJlKFwidWkvZGlhbG9nc1wiKTtcbmltcG9ydCBlbnVtcyA9IHJlcXVpcmUoXCJ1aS9lbnVtc1wiKTtcbmltcG9ydCBmaWxlU3lzdGVtID0gcmVxdWlyZShcImZpbGUtc3lzdGVtXCIpO1xuaW1wb3J0IGltYWdlU291cmNlID0gcmVxdWlyZShcImltYWdlLXNvdXJjZVwiKTtcbmltcG9ydCBwbGF0Zm9ybU1vZHVsZSA9IHJlcXVpcmUoXCJwbGF0Zm9ybVwiKTtcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gXCJ1dGlscy91dGlsc1wiO1xuXG5pbXBvcnQgZHJhd2VyTW9kdWxlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC10ZWxlcmlrLXVpL3NpZGVkcmF3ZXJcIik7XG5pbXBvcnQgeyBGcmVzY29EcmF3ZWUsIEZpbmFsRXZlbnREYXRhIH0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1mcmVzY29cIjtcbmltcG9ydCAqIGFzIFNvY2lhbFNoYXJlIGZyb20gXCJuYXRpdmVzY3JpcHQtc29jaWFsLXNoYXJlXCI7XG5cbmlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XG4gICAgdmFyIHRvYXN0ID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC10b2FzdFwiKTtcbn1cblxuaW1wb3J0IHsgRXBpY1ZpZXdNb2RlbCwgRXBpY0l0ZW0gfSBmcm9tIFwiLi4vLi4vdmlldy1tb2RlbHMvZXBpYy9lcGljLW1vZGVsXCI7XG5sZXQgZXBpY1ZpZXdNb2RlbCA9IG5ldyBFcGljVmlld01vZGVsKCk7XG5cbmxldCBwYWdlOiBQYWdlO1xubGV0IHNoYXJlQnV0dG9uOiBCdXR0b247XG5sZXQgc2F2ZUJ1dHRvbjogQnV0dG9uO1xubGV0IGRlc2t0b3BCdXR0b246IEJ1dHRvbjtcbmxldCBpb3NJbWFnZTogSW1hZ2U7XG5sZXQgY3VycmVudEltYWdlOiBpbWFnZVNvdXJjZS5JbWFnZVNvdXJjZTtcblxudmFyIGN1cnJlbnRTYXZlZFBhdGg6IHN0cmluZztcblxuZXhwb3J0IGZ1bmN0aW9uIG9uUGFnZUxvYWRlZChhcmdzOiBFdmVudERhdGEpIHtcbiAgICBwYWdlID0gPFBhZ2U+YXJncy5vYmplY3Q7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvblNjcm9sbFN3aXBlKGFyZ3M6IFN3aXBlR2VzdHVyZUV2ZW50RGF0YSkge1xuICAgIC8vIGlmIChhcmdzLmRpcmVjdGlvbiA9PT0gMSkge1xuICAgIC8vICAgICBwcmV2aW91c0RhdGUoKTtcbiAgICAvLyB9IGVsc2UgaWYgKGFyZ3MuZGlyZWN0aW9uID09PSAyKSB7XG4gICAgLy8gICAgIG5leHREYXRlKCk7XG4gICAgLy8gfSAgIFxufVxuXG5leHBvcnQgZnVuY3Rpb24gb25QYWdlTmF2aWdhdGVkVG8oYXJnczogRXZlbnREYXRhKSB7XG4gICAgcGFnZSA9IDxQYWdlPmFyZ3Mub2JqZWN0O1xuICAgIHZhciBwYWdlQ29udGFpbmVyID0gPFN0YWNrTGF5b3V0PnBhZ2UuZ2V0Vmlld0J5SWQoXCJwYWdlQ29udGFpbmVyXCIpO1xuXG4gICAgc2hhcmVCdXR0b24gPSA8QnV0dG9uPnBhZ2UuZ2V0Vmlld0J5SWQoXCJidG4tc2hhcmVcIik7XG4gICAgc2F2ZUJ1dHRvbiA9IDxCdXR0b24+cGFnZS5nZXRWaWV3QnlJZChcImJ0bi1zYXZlXCIpO1xuICAgIGRlc2t0b3BCdXR0b24gPSA8QnV0dG9uPnBhZ2UuZ2V0Vmlld0J5SWQoXCJidG4tZGVza1wiKTtcblxuICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XG4gICAgICAgIHNldEJ1dHRvbnNPcGFjaXR5KDAuMik7XG4gICAgICAgIHNldFVzZXJJbnRlcmFjdGlvbihmYWxzZSk7XG4gICAgfVxuXG4gICAgaWYgKGFwcGxpY2F0aW9uLmlvcykge1xuICAgICAgICBpb3NJbWFnZSA9IDxJbWFnZT5wYWdlLmdldFZpZXdCeUlkKFwiaW9zLWltYWdlXCIpO1xuICAgIH1cblxuICAgIGlmICghZXBpY1ZpZXdNb2RlbC5nZXQoXCJkYXRhSXRlbVwiKSkge1xuICAgICAgICBlcGljVmlld01vZGVsLmluaXREYXRhSXRlbXMoKTtcbiAgICB9XG5cbiAgICBwYWdlQ29udGFpbmVyLmJpbmRpbmdDb250ZXh0ID0gZXBpY1ZpZXdNb2RlbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9uU2F2ZUltYWdlKGFyZ3M6IEV2ZW50RGF0YSkge1xuXG4gICAgaWYgKGFwcGxpY2F0aW9uLmlvcykge1xuICAgICAgICBpbWFnZVNvdXJjZS5mcm9tVXJsKGlvc0ltYWdlLnNyYylcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgc2F2ZUZpbGUocmVzKTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coZXJyLnN0YWNrKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xuICAgICAgICBzYXZlRmlsZShjdXJyZW50SW1hZ2UpO1xuICAgICAgICB0b2FzdC5tYWtlVGV4dChcIlBob3RvIHNhdmVkIGluIC9Eb3dubG9hZHMvQ29zbW9zRGF0YUJhbmsvXCIpLnNob3coKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvblNldFdhbGxwYXBlcihhcmdzOiBFdmVudERhdGEpIHtcblxuICAgIGlmIChhcHBsaWNhdGlvbi5pb3MpIHtcbiAgICAgICAgaW1hZ2VTb3VyY2UuZnJvbVVybChpb3NJbWFnZS5zcmMpXG4gICAgICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbWFnZSA9IHJlczsgLy8gVE9ETyA6IHNldCB3YWxscGFwZXIgZm9yIGlPU1xuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlcnIuc3RhY2spO1xuICAgICAgICAgICAgfSk7IDtcbiAgICB9IGVsc2UgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcblxuICAgICAgICBzYXZlRmlsZShjdXJyZW50SW1hZ2UpO1xuXG4gICAgICAgIHZhciB3YWxscGFwZXJNYW5hZ2VyID0gYXBwbGljYXRpb24uYW5kcm9pZC5uYXRpdmVBcHAuV2FsbHBhcGVyTWFuYWdlci5nZXRJbnN0YW5jZSh1dGlscy5hZC5nZXRBcHBsaWNhdGlvbkNvbnRleHQoKSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB2YXIgaW1hZ2VUb1NldCA9IGltYWdlU291cmNlLmZyb21GaWxlKGN1cnJlbnRTYXZlZFBhdGgpO1xuICAgICAgICAgICAgd2FsbHBhcGVyTWFuYWdlci5zZXRCaXRtYXAoaW1hZ2VUb1NldC5hbmRyb2lkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGVycm9yLnN0YWNrKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRvYXN0Lm1ha2VUZXh0KFwiV2FsbHBhcGVyIFNldCFcIikuc2hvdygpO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9uU2hhcmUoYXJnczogRXZlbnREYXRhKSB7XG4gICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcbiAgICAgICAgU29jaWFsU2hhcmUuc2hhcmVJbWFnZShjdXJyZW50SW1hZ2UsIFwiTkFTQSBFUElDXCIpO1xuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uaW9zKSB7XG4gICAgICAgIGltYWdlU291cmNlLmZyb21VcmwoaW9zSW1hZ2Uuc3JjKVxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgICAgICBTb2NpYWxTaGFyZS5zaGFyZUltYWdlKHJlcyk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGVyci5zdGFjayk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmV2aW91c0RhdGUoKSB7XG4gICAgLy8gaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcbiAgICAvLyAgICAgc2V0QnV0dG9uc09wYWNpdHkoMC4yKTtcbiAgICAvLyAgICAgc2V0VXNlckludGVyYWN0aW9uKGZhbHNlKTtcbiAgICAvLyB9XG5cbiAgICAvLyAvLyBUT0RPOiBhZGQgY2hlY2sgaWYgdGhlIGRhdGUgaXMgbm90IHRvbyBmYXIgaW4gdGhlIHBhc3QgKGNoZWNrIGZpcnN0IEVQSUMgZGF0ZSlcbiAgICAvLyB2YXIgY3VycmVudERhdGUgPSBlcGljVmlld01vZGVsLmdldChcInNlbGVjdGVkRGF0ZVwiKTtcbiAgICAvLyBjdXJyZW50RGF0ZS5zZXREYXRlKGN1cnJlbnREYXRlLmdldERhdGUoKS0xKTtcbiAgICAvLyBlcGljVmlld01vZGVsLnNldChcInNlbGVjdGVkRGF0ZVwiLCBjdXJyZW50RGF0ZSk7XG4gICAgLy8gZXBpY1ZpZXdNb2RlbC5pbml0RGF0YUl0ZW1zKCk7IFxufVxuXG5leHBvcnQgZnVuY3Rpb24gbmV4dERhdGUoKSB7XG4gICAgLy8gaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcbiAgICAvLyAgICAgc2V0QnV0dG9uc09wYWNpdHkoMC4yKTtcbiAgICAvLyAgICAgc2V0VXNlckludGVyYWN0aW9uKGZhbHNlKTtcbiAgICAvLyB9XG5cbiAgICAvLyB2YXIgY3VycmVudERhdGUgPSBlcGljVmlld01vZGVsLmdldChcInNlbGVjdGVkRGF0ZVwiKTtcbiAgICAvLyBpZiAoY3VycmVudERhdGUgPj0gbmV3IERhdGUoKSkge1xuICAgIC8vICAgICBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xuICAgIC8vICAgICAgICAgdG9hc3QubWFrZVRleHQoXCJDYW4gbm90IGxvYWQgcGhvdG9zIGZyb20gZnV0dXJlIVwiKS5zaG93KCk7XG4gICAgLy8gICAgIH1cbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgICBjdXJyZW50RGF0ZS5zZXREYXRlKGN1cnJlbnREYXRlLmdldERhdGUoKSsxKTtcbiAgICAvLyAgICAgZXBpY1ZpZXdNb2RlbC5zZXQoXCJzZWxlY3RlZERhdGVcIiwgY3VycmVudERhdGUpO1xuICAgIC8vICAgICBlcGljVmlld01vZGVsLmluaXREYXRhSXRlbXMoKTsgXG4gICAgLy8gfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gb25TdWJtaXQoYXJnczogRXZlbnREYXRhKSB7XG4gICAgY29uc29sZS5sb2coXCJvbiBzdWJtaXQgXCIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb25GaW5hbEltYWdlU2V0KGFyZ3M6IEZpbmFsRXZlbnREYXRhKSB7XG4gICAgdmFyIGRyYXdlZSA9IGFyZ3Mub2JqZWN0IGFzIEZyZXNjb0RyYXdlZTtcblxuICAgIGltYWdlU291cmNlLmZyb21VcmwoZHJhd2VlLmltYWdlVXJpKVxuICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgY3VycmVudEltYWdlID0gcmVzO1xuXG4gICAgICAgICAgICBzYXZlQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAwLjIsIHJvdGF0ZTogMzYwIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzdSA9PiB7IHJldHVybiBzYXZlQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAwLjUsIHJvdGF0ZTogMTgwLCBkdXJhdGlvbjogMTUwIH0pOyB9KVxuICAgICAgICAgICAgICAgIC50aGVuKHJlc3VsID0+IHsgcmV0dXJuIHNhdmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDEuMCwgcm90YXRlOiAwLCBkdXJhdGlvbjogMTUwIH0pOyB9KTtcblxuICAgICAgICAgICAgZGVza3RvcEJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC4yLCByb3RhdGU6IDM2MCB9KVxuICAgICAgICAgICAgICAgIC50aGVuKHJlc3UgPT4geyByZXR1cm4gZGVza3RvcEJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC41LCByb3RhdGU6IDE4MCwgZHVyYXRpb246IDE1MCB9KTsgfSlcbiAgICAgICAgICAgICAgICAudGhlbihyZXN1bCA9PiB7IHJldHVybiBkZXNrdG9wQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAxLjAsIHJvdGF0ZTogMCwgZHVyYXRpb246IDE1MCB9KTsgfSk7XG5cbiAgICAgICAgICAgIHNoYXJlQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAwLjIsIHJvdGF0ZTogMzYwIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzdSA9PiB7IHJldHVybiBzaGFyZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC41LCByb3RhdGU6IDE4MCwgZHVyYXRpb246IDE1MCB9KTsgfSlcbiAgICAgICAgICAgICAgICAudGhlbihyZXN1bCA9PiB7IHJldHVybiBzaGFyZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMS4wLCByb3RhdGU6IDAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pO1xuXG4gICAgICAgICAgICBzZXRVc2VySW50ZXJhY3Rpb24odHJ1ZSk7XG5cbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGVyci5zdGFjayk7XG4gICAgICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUZpbGUocmVzOiBpbWFnZVNvdXJjZS5JbWFnZVNvdXJjZSkge1xuICAgIHZhciB1cmwgPSBlcGljVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLnVybDtcbiAgICB2YXIgZmlsZU5hbWUgPSB1cmwuc3Vic3RyaW5nKHVybC5sYXN0SW5kZXhPZihcIi9cIikgKyAxKTtcbiAgICB2YXIgbiA9IGZpbGVOYW1lLmluZGV4T2YoXCIuXCIpO1xuICAgIGZpbGVOYW1lID0gZmlsZU5hbWUuc3Vic3RyaW5nKDAsIG4gIT09IC0xID8gbiA6IGZpbGVOYW1lLmxlbmd0aCkgKyBcIi5qcGVnXCI7XG5cbiAgICBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgIHZhciBhbmRyb2lkRG93bmxvYWRzUGF0aCA9IGFwcGxpY2F0aW9uLmFuZHJvaWQubmF0aXZlQXBwLm9zLkVudmlyb25tZW50LmdldEV4dGVybmFsU3RvcmFnZVB1YmxpY0RpcmVjdG9yeShhcHBsaWNhdGlvbi5hbmRyb2lkLm5hdGl2ZUFwcC5vcy5FbnZpcm9ubWVudC5ESVJFQ1RPUllfRE9XTkxPQURTKS50b1N0cmluZygpO1xuICAgICAgICB2YXIgY29zbW9zRm9sZGVyUGF0aCA9IGZpbGVTeXN0ZW0ucGF0aC5qb2luKGFuZHJvaWREb3dubG9hZHNQYXRoLCBcIkNvc21vc0RhdGFCYW5rXCIpO1xuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uaW9zKSB7XG4gICAgICAgIC8vIFRPRE8gOiAgdGhpcyB3b3JrcyAtIGJ1dCB3aGVyZSBhcmUgdGhlIGltYWdlcyA/XG4gICAgICAgIHZhciBpb3NEb3dubG9hZFBhdGggPSBmaWxlU3lzdGVtLmtub3duRm9sZGVycy5kb2N1bWVudHMoKTtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXNoYWRvd2VkLXZhcmlhYmxlXG4gICAgICAgIHZhciBjb3Ntb3NGb2xkZXJQYXRoID0gZmlsZVN5c3RlbS5wYXRoLmpvaW4oaW9zRG93bmxvYWRQYXRoLnBhdGgsIFwiQ29zbW9zRGF0YUJhbmtcIik7XG4gICAgfVxuXG4gICAgdmFyIGZvbGRlciA9IGZpbGVTeXN0ZW0uRm9sZGVyLmZyb21QYXRoKGNvc21vc0ZvbGRlclBhdGgpO1xuICAgIHZhciBwYXRoID0gZmlsZVN5c3RlbS5wYXRoLmpvaW4oY29zbW9zRm9sZGVyUGF0aCwgZmlsZU5hbWUpO1xuICAgIHZhciBleGlzdHMgPSBmaWxlU3lzdGVtLkZpbGUuZXhpc3RzKHBhdGgpO1xuXG4gICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgdmFyIHNhdmVkID0gcmVzLnNhdmVUb0ZpbGUocGF0aCwgXCJqcGVnXCIpO1xuICAgIH1cblxuICAgIGN1cnJlbnRTYXZlZFBhdGggPSBwYXRoO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb25Jb3NTaGFyZSgpIHtcbiAgICBjb25zb2xlLmxvZyhcImlPUyBzaGFyZSB0YXBwZWQhIDFcIik7XG4gICAgY29uc29sZS5sb2coaW9zSW1hZ2Uuc3JjKTtcblxuICAgIGltYWdlU291cmNlLmZyb21VcmwoaW9zSW1hZ2Uuc3JjKVxuICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgU29jaWFsU2hhcmUuc2hhcmVJbWFnZShyZXMpO1xuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coZXJyLnNzdGFjayk7XG4gICAgICAgIH0pO1xufVxuXG5mdW5jdGlvbiBmb3JtYXREYXRlKGRhdGUpIHtcbiAgICB2YXIgZCA9IG5ldyBEYXRlKGRhdGUpLFxuICAgICAgICBtb250aCA9IFwiXCIgKyAoZC5nZXRNb250aCgpICsgMSksXG4gICAgICAgIGRheSA9IFwiXCIgKyBkLmdldERhdGUoKSxcbiAgICAgICAgeWVhciA9IGQuZ2V0RnVsbFllYXIoKTtcblxuICAgIGlmIChtb250aC5sZW5ndGggPCAyKSB7XG4gICAgICAgIG1vbnRoID0gXCIwXCIgKyBtb250aDtcbiAgICB9XG5cbiAgICBpZiAoZGF5Lmxlbmd0aCA8IDIpIHtcbiAgICAgICAgZGF5ID0gXCIwXCIgKyBkYXk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFt5ZWFyLCBtb250aCwgZGF5XS5qb2luKFwiLVwiKTtcbn1cblxuZnVuY3Rpb24gc2V0VXNlckludGVyYWN0aW9uKHN0YXRlOiBib29sZWFuKSB7XG4gICAgc2hhcmVCdXR0b24uaXNVc2VySW50ZXJhY3Rpb25FbmFibGVkID0gc3RhdGU7XG4gICAgc2F2ZUJ1dHRvbi5pc1VzZXJJbnRlcmFjdGlvbkVuYWJsZWQgPSBzdGF0ZTtcbiAgICBkZXNrdG9wQnV0dG9uLmlzVXNlckludGVyYWN0aW9uRW5hYmxlZCA9IHN0YXRlO1xufVxuXG5mdW5jdGlvbiBzZXRCdXR0b25zT3BhY2l0eSh2YWx1ZTogbnVtYmVyKSB7XG4gICAgc2F2ZUJ1dHRvbi5vcGFjaXR5ID0gdmFsdWU7XG4gICAgZGVza3RvcEJ1dHRvbi5vcGFjaXR5ID0gdmFsdWU7XG4gICAgc2hhcmVCdXR0b24ub3BhY2l0eSA9IHZhbHVlO1xufVxuIl19