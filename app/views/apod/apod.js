"use strict";
var application = require("application");
var enums = require("ui/enums");
var fileSystem = require("file-system");
var imageSource = require("image-source");
var utils = require("utils/utils");
var SocialShare = require("nativescript-social-share");
var firebase = require("nativescript-plugin-firebase");
var okHttp = require("nativescript-okhttp");
var youtubeHelpers = require("../helpers/youtube/youtube-helpers");
var formatters = require("../helpers/formaters");
if (application.android) {
    var toast = require("nativescript-toast");
    var youtube = require("nativescript-youtube-player");
}
var credentials_1 = require("../../files/credentials");
var apod_model_1 = require("../../view-models/apod/apod-model");
var apodViewModel = new apod_model_1.ApodViewModel();
apodViewModel.set("isPlayerVisible", false);
apodViewModel.set("youtube_api_key", credentials_1.YOUTUBE_API_KEY);
apodViewModel.set("youtube_video_key", "2zNSgSzhBfM");
var page;
var shareButton;
var saveButton;
var desktopButton;
var iosImage;
var currentImage;
var currentSavedPath;
var player;
function onPageLoaded(args) {
    page = args.object;
}
exports.onPageLoaded = onPageLoaded;
function onScrollSwipe(args) {
    if (args.direction === 1) {
        previousDate();
    }
    else if (args.direction === 2) {
        nextDate();
    }
}
exports.onScrollSwipe = onScrollSwipe;
function onPageNavigatedTo(args) {
    page = args.object;
    shareButton = page.getViewById("btn-shar");
    saveButton = page.getViewById("btn-save");
    desktopButton = page.getViewById("btn-desk");
    if (application.android) {
        player = page.getViewById("player");
        setButtonsOpacity(0.2);
        setUserInteraction(false);
    }
    if (application.ios) {
        iosImage = page.getViewById("ios-image");
    }
    if (!apodViewModel.get("dataItem")) {
        apodViewModel.initDataItems().then(function (res) {
            console.log(apodViewModel.get("dataItem").media_type === "video");
            if (application.android && (apodViewModel.get("dataItem").media_type === "video")) {
                initPlayer();
            }
            else {
                player.pause();
                apodViewModel.set("isPlayerVisible", false);
            }
        });
    }
    page.bindingContext = apodViewModel;
}
exports.onPageNavigatedTo = onPageNavigatedTo;
function previousDate() {
    if (application.android) {
        setButtonsOpacity(0.2);
        setUserInteraction(false);
    }
    // TODO: add check if the date is not too far in the past (check first APOD date)
    var currentDate = apodViewModel.get("selectedDate");
    currentDate.setDate(currentDate.getDate() - 1);
    apodViewModel.set("selectedDate", currentDate);
    apodViewModel.initDataItems(formatters.formatDate(currentDate)).then(function (res) {
        if (application.android && (apodViewModel.get("dataItem").media_type === "video")) {
            initPlayer();
        }
        else {
            player.pause();
            apodViewModel.set("isPlayerVisible", false);
        }
    });
}
exports.previousDate = previousDate;
function nextDate() {
    if (application.android) {
        setButtonsOpacity(0.2);
        setUserInteraction(false);
    }
    var currentDate = apodViewModel.get("selectedDate");
    if (currentDate >= new Date()) {
        if (application.android) {
            toast.makeText("Can not load photos from the future!").show();
        }
    }
    else {
        currentDate.setDate(currentDate.getDate() + 1);
        apodViewModel.set("selectedDate", currentDate);
        apodViewModel.initDataItems(formatters.formatDate(currentDate)).then(function (res) {
            if (application.android && (apodViewModel.get("dataItem").media_type === "video")) {
                initPlayer();
            }
            else {
                player.pause();
                apodViewModel.set("isPlayerVisible", false);
            }
        });
    }
}
exports.nextDate = nextDate;
function setCurrentImage(imageUri) {
    // okhttp is blocking so no need to return Promise!
    var inputStream = okHttp.getImage(imageUri);
    var image = imageSource.fromData(inputStream);
    return image;
}
function onFinalImageSet(args) {
    var drawee = args.object;
    console.log("drawee.imageUri:" + drawee.imageUri);
    console.log("apodViewModel: " + apodViewModel.get("dataItem").url);
    currentImage = setCurrentImage(drawee.imageUri);
    saveButton.animate({ opacity: 0.2, rotate: 360 })
        .then(function () { return saveButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
        .then(function () { return saveButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
    desktopButton.animate({ opacity: 0.2, rotate: 360 })
        .then(function () { return desktopButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
        .then(function () { return desktopButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
    shareButton.animate({ opacity: 0.2, rotate: 360 })
        .then(function () { return shareButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
        .then(function () { return shareButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); })
        .then(function () { setUserInteraction(true); });
    // this one is returnint Response cannot be resolved as image in {N} 2.4.2
    // imageSource.fromUrl(drawee.imageUri)
    //     .then(res => {
    //         currentImage = res;
    //         saveButton.animate({ opacity: 0.2, rotate: 360 })
    //             .then(() => { return saveButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
    //             .then(() => { return saveButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
    //         desktopButton.animate({ opacity: 0.2, rotate: 360 })
    //             .then(() => { return desktopButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
    //             .then(() => { return desktopButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
    //         shareButton.animate({ opacity: 0.2, rotate: 360 })
    //             .then(() => { return shareButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
    //             .then(() => { return shareButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
    //         setUserInteraction(true);
    //     }).catch(err => {
    //         console.log(err);
    //     });
}
exports.onFinalImageSet = onFinalImageSet;
function setUserInteraction(state) {
    shareButton.isUserInteractionEnabled = state;
    saveButton.isUserInteractionEnabled = state;
    desktopButton.isUserInteractionEnabled = state;
}
function setButtonsOpacity(value) {
    saveButton.opacity = value;
    desktopButton.opacity = value;
    shareButton.opacity = value;
}
function saveFile(res) {
    var url = apodViewModel.get("dataItem").url;
    var fileName = url.substring(url.lastIndexOf("/") + 1);
    var n = fileName.indexOf(".");
    fileName = fileName.substring(0, n !== -1 ? n : fileName.length) + ".jpeg";
    var cosmosFolderPath;
    if (application.android) {
        var androidDownloadsPath = android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_DOWNLOADS).toString();
        cosmosFolderPath = fileSystem.path.join(androidDownloadsPath, "CosmosDataBank");
    }
    else if (application.ios) {
        // TODO :  this works - but where are the images ?
        var iosDownloadPath = fileSystem.knownFolders.documents();
        cosmosFolderPath = fileSystem.path.join(iosDownloadPath.path, "CosmosDataBank");
    }
    var folder = fileSystem.Folder.fromPath(cosmosFolderPath);
    var path = fileSystem.path.join(cosmosFolderPath, fileName);
    var exists = fileSystem.File.exists(path);
    if (!exists) {
        var saved = res.saveToFile(path, enums.ImageFormat.jpeg);
    }
    currentSavedPath = path;
}
function onSaveImage(args) {
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            saveFile(res);
        }).catch(function (err) {
            // console.log(err);
        });
    }
    else if (application.android) {
        saveFile(currentImage);
        toast.makeText("Photo saved in /Downloads/CosmosDataBank/").show();
    }
}
exports.onSaveImage = onSaveImage;
function onSetWallpaper(args) {
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            currentImage = res; // TODO : set wallpaper for iOS
        }).catch(function (err) {
            // console.log(err);
        });
        ;
    }
    else if (application.android) {
        saveFile(currentImage);
        var wallpaperManager = android.app.WallpaperManager.getInstance(utils.ad.getApplicationContext());
        try {
            var imageToSet = imageSource.fromFile(currentSavedPath);
            wallpaperManager.setBitmap(imageToSet.android);
        }
        catch (error) {
        }
        toast.makeText("Wallpaper Set!").show();
    }
}
exports.onSetWallpaper = onSetWallpaper;
function onShare(args) {
    firebase.push("/favorites", {
        "dataItem": apodViewModel.get("dataItem"),
        "updateTs": firebase["ServerValue"].TIMESTAMP
    }).then(function (result) {
        console.log("created key: " + result.key);
    });
    if (application.android) {
        SocialShare.shareImage(currentImage, "NASA APOD");
    }
    else if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            SocialShare.shareImage(res);
        }).catch(function (err) {
            // console.log(err);
        });
    }
}
exports.onShare = onShare;
function initPlayer() {
    var mediaUrl = apodViewModel.get("dataItem").url;
    if (mediaUrl.indexOf("youtube") >= 0) {
        apodViewModel.set("isPlayerVisible", true);
        var youtubeID = youtubeHelpers.getYouTubeID(mediaUrl);
        player.loadVideo(youtubeID, 10); // pass the actual video here or load web-view
        player.play();
    }
    else {
        player.pause();
        apodViewModel.set("isPlayerVisible", false);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBvZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwb2QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQVlBLHlDQUE0QztBQUc1QyxnQ0FBbUM7QUFDbkMsd0NBQTJDO0FBQzNDLDBDQUE2QztBQUU3QyxtQ0FBcUM7QUFLckMsdURBQXlEO0FBQ3pELHVEQUF5RDtBQUV6RCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUU1QyxtRUFBcUU7QUFDckUsaURBQW1EO0FBRW5ELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3RCLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQzFDLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBQ3pELENBQUM7QUFFRCx1REFBMEQ7QUFFMUQsZ0VBQTRFO0FBRTVFLElBQUksYUFBYSxHQUFHLElBQUksMEJBQWEsRUFBRSxDQUFDO0FBQ3hDLGFBQWEsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDNUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSw2QkFBZSxDQUFDLENBQUM7QUFDdEQsYUFBYSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsRUFBRSxhQUFhLENBQUMsQ0FBQztBQUV0RCxJQUFJLElBQVUsQ0FBQztBQUNmLElBQUksV0FBbUIsQ0FBQztBQUN4QixJQUFJLFVBQWtCLENBQUM7QUFDdkIsSUFBSSxhQUFxQixDQUFDO0FBQzFCLElBQUksUUFBZSxDQUFDO0FBQ3BCLElBQUksWUFBcUMsQ0FBQztBQUUxQyxJQUFJLGdCQUF3QixDQUFDO0FBQzdCLElBQUksTUFBTSxDQUFDO0FBRVgsc0JBQTZCLElBQWU7SUFDeEMsSUFBSSxHQUFTLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDN0IsQ0FBQztBQUZELG9DQUVDO0FBRUQsdUJBQThC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QyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU1RixhQUFhLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUM7U0FDL0MsSUFBSSxDQUFDLGNBQVEsTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDM0YsSUFBSSxDQUFDLGNBQVEsTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUvRixXQUFXLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUM7U0FDN0MsSUFBSSxDQUFDLGNBQVEsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDekYsSUFBSSxDQUFDLGNBQVEsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdkYsSUFBSSxDQUFDLGNBQVEsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUc3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cUJDO0FBRUQ7SUFDSSxJQUFJLFFBQVEsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQztJQUVqRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMzQyxJQUFJLFNBQVMsR0FBRyxjQUFjLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsOENBQThDO1FBQy9FLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDSixNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDZixhQUFhLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2hELENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnREYXRhLCBQcm9wZXJ0eUNoYW5nZURhdGEgfSBmcm9tIFwiZGF0YS9vYnNlcnZhYmxlXCI7XHJcbmltcG9ydCB7IEJ1dHRvbiB9IGZyb20gXCJ1aS9idXR0b25cIjtcclxuaW1wb3J0IHsgSW1hZ2UgfSBmcm9tIFwidWkvaW1hZ2VcIjtcclxuaW1wb3J0IHsgSW1hZ2VTb3VyY2UgfSBmcm9tIFwiaW1hZ2Utc291cmNlXCI7XHJcbmltcG9ydCB7IEdlc3R1cmVUeXBlcywgR2VzdHVyZUV2ZW50RGF0YSwgU3dpcGVHZXN0dXJlRXZlbnREYXRhIH0gZnJvbSBcInVpL2dlc3R1cmVzXCI7XHJcbmltcG9ydCB7IEdyaWRMYXlvdXQgfSBmcm9tIFwidWkvbGF5b3V0cy9ncmlkLWxheW91dFwiO1xyXG5pbXBvcnQgeyBMaXN0VmlldyB9IGZyb20gXCJ1aS9saXN0LXZpZXdcIjtcclxuaW1wb3J0IHsgUGFnZSB9IGZyb20gXCJ1aS9wYWdlXCI7XHJcbmltcG9ydCB7IFNjcm9sbFZpZXcgfSBmcm9tIFwidWkvc2Nyb2xsLXZpZXdcIjtcclxuaW1wb3J0IHsgU3RhY2tMYXlvdXQgfSBmcm9tIFwidWkvbGF5b3V0cy9zdGFjay1sYXlvdXRcIjtcclxuaW1wb3J0IHsgdG9wbW9zdCB9IGZyb20gXCJ1aS9mcmFtZVwiO1xyXG5cclxuaW1wb3J0IGFwcGxpY2F0aW9uID0gcmVxdWlyZShcImFwcGxpY2F0aW9uXCIpO1xyXG5pbXBvcnQgY29sb3IgPSByZXF1aXJlKFwiY29sb3JcIik7XHJcbmltcG9ydCBkaWFsb2dzID0gcmVxdWlyZShcInVpL2RpYWxvZ3NcIik7XHJcbmltcG9ydCBlbnVtcyA9IHJlcXVpcmUoXCJ1aS9lbnVtc1wiKTtcclxuaW1wb3J0IGZpbGVTeXN0ZW0gPSByZXF1aXJlKFwiZmlsZS1zeXN0ZW1cIik7XHJcbmltcG9ydCBpbWFnZVNvdXJjZSA9IHJlcXVpcmUoXCJpbWFnZS1zb3VyY2VcIik7XHJcbmltcG9ydCBwbGF0Zm9ybU1vZHVsZSA9IHJlcXVpcmUoXCJwbGF0Zm9ybVwiKTtcclxuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSBcInV0aWxzL3V0aWxzXCI7XHJcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcclxuXHJcbmltcG9ydCBkcmF3ZXJNb2R1bGUgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXRlbGVyaWstdWkvc2lkZWRyYXdlclwiKTtcclxuaW1wb3J0IHsgRnJlc2NvRHJhd2VlLCBGaW5hbEV2ZW50RGF0YSB9IGZyb20gXCJuYXRpdmVzY3JpcHQtZnJlc2NvXCI7XHJcbmltcG9ydCAqIGFzIFNvY2lhbFNoYXJlIGZyb20gXCJuYXRpdmVzY3JpcHQtc29jaWFsLXNoYXJlXCI7XHJcbmltcG9ydCAqIGFzIGZpcmViYXNlIGZyb20gXCJuYXRpdmVzY3JpcHQtcGx1Z2luLWZpcmViYXNlXCI7XHJcblxyXG52YXIgb2tIdHRwID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1va2h0dHBcIik7XHJcblxyXG5pbXBvcnQgKiBhcyB5b3V0dWJlSGVscGVycyBmcm9tIFwiLi4vaGVscGVycy95b3V0dWJlL3lvdXR1YmUtaGVscGVyc1wiO1xyXG5pbXBvcnQgKiBhcyBmb3JtYXR0ZXJzIGZyb20gXCIuLi9oZWxwZXJzL2Zvcm1hdGVyc1wiO1xyXG5cclxuaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcclxuICAgIHZhciB0b2FzdCA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtdG9hc3RcIik7XHJcbiAgICB2YXIgeW91dHViZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQteW91dHViZS1wbGF5ZXJcIik7XHJcbn1cclxuXHJcbmltcG9ydCB7IFlPVVRVQkVfQVBJX0tFWSB9IGZyb20gXCIuLi8uLi9maWxlcy9jcmVkZW50aWFsc1wiO1xyXG5cclxuaW1wb3J0IHsgQXBvZFZpZXdNb2RlbCwgQXBvZEl0ZW0gfSBmcm9tIFwiLi4vLi4vdmlldy1tb2RlbHMvYXBvZC9hcG9kLW1vZGVsXCI7XHJcblxyXG5sZXQgYXBvZFZpZXdNb2RlbCA9IG5ldyBBcG9kVmlld01vZGVsKCk7XHJcbmFwb2RWaWV3TW9kZWwuc2V0KFwiaXNQbGF5ZXJWaXNpYmxlXCIsIGZhbHNlKTtcclxuYXBvZFZpZXdNb2RlbC5zZXQoXCJ5b3V0dWJlX2FwaV9rZXlcIiwgWU9VVFVCRV9BUElfS0VZKTtcclxuYXBvZFZpZXdNb2RlbC5zZXQoXCJ5b3V0dWJlX3ZpZGVvX2tleVwiLCBcIjJ6TlNnU3poQmZNXCIpO1xyXG5cclxubGV0IHBhZ2U6IFBhZ2U7XHJcbmxldCBzaGFyZUJ1dHRvbjogQnV0dG9uO1xyXG5sZXQgc2F2ZUJ1dHRvbjogQnV0dG9uO1xyXG5sZXQgZGVza3RvcEJ1dHRvbjogQnV0dG9uO1xyXG5sZXQgaW9zSW1hZ2U6IEltYWdlO1xyXG5sZXQgY3VycmVudEltYWdlOiBpbWFnZVNvdXJjZS5JbWFnZVNvdXJjZTtcclxuXHJcbnZhciBjdXJyZW50U2F2ZWRQYXRoOiBzdHJpbmc7XHJcbmxldCBwbGF5ZXI7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gb25QYWdlTG9hZGVkKGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gICAgcGFnZSA9IDxQYWdlPmFyZ3Mub2JqZWN0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gb25TY3JvbGxTd2lwZShhcmdzOiBTd2lwZUdlc3R1cmVFdmVudERhdGEpIHtcclxuICAgIGlmIChhcmdzLmRpcmVjdGlvbiA9PT0gMSkge1xyXG4gICAgICAgIHByZXZpb3VzRGF0ZSgpO1xyXG4gICAgfSBlbHNlIGlmIChhcmdzLmRpcmVjdGlvbiA9PT0gMikge1xyXG4gICAgICAgIG5leHREYXRlKCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvblBhZ2VOYXZpZ2F0ZWRUbyhhcmdzOiBFdmVudERhdGEpIHtcclxuICAgIHBhZ2UgPSA8UGFnZT5hcmdzLm9iamVjdDtcclxuXHJcbiAgICBzaGFyZUJ1dHRvbiA9IDxCdXR0b24+cGFnZS5nZXRWaWV3QnlJZChcImJ0bi1zaGFyXCIpO1xyXG4gICAgc2F2ZUJ1dHRvbiA9IDxCdXR0b24+cGFnZS5nZXRWaWV3QnlJZChcImJ0bi1zYXZlXCIpO1xyXG4gICAgZGVza3RvcEJ1dHRvbiA9IDxCdXR0b24+cGFnZS5nZXRWaWV3QnlJZChcImJ0bi1kZXNrXCIpO1xyXG5cclxuICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XHJcbiAgICAgICAgcGxheWVyID0gcGFnZS5nZXRWaWV3QnlJZChcInBsYXllclwiKTtcclxuICAgICAgICBzZXRCdXR0b25zT3BhY2l0eSgwLjIpO1xyXG4gICAgICAgIHNldFVzZXJJbnRlcmFjdGlvbihmYWxzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGFwcGxpY2F0aW9uLmlvcykge1xyXG4gICAgICAgIGlvc0ltYWdlID0gPEltYWdlPnBhZ2UuZ2V0Vmlld0J5SWQoXCJpb3MtaW1hZ2VcIik7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpKSB7XHJcbiAgICAgICAgYXBvZFZpZXdNb2RlbC5pbml0RGF0YUl0ZW1zKCkudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLm1lZGlhX3R5cGUgPT09IFwidmlkZW9cIik7XHJcbiAgICAgICAgICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkICYmIChhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLm1lZGlhX3R5cGUgPT09IFwidmlkZW9cIikpIHtcclxuICAgICAgICAgICAgICAgIGluaXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBsYXllci5wYXVzZSgpO1xyXG4gICAgICAgICAgICAgICAgYXBvZFZpZXdNb2RlbC5zZXQoXCJpc1BsYXllclZpc2libGVcIiwgZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcGFnZS5iaW5kaW5nQ29udGV4dCA9IGFwb2RWaWV3TW9kZWw7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwcmV2aW91c0RhdGUoKSB7XHJcbiAgICBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xyXG4gICAgICAgIHNldEJ1dHRvbnNPcGFjaXR5KDAuMik7XHJcbiAgICAgICAgc2V0VXNlckludGVyYWN0aW9uKGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUT0RPOiBhZGQgY2hlY2sgaWYgdGhlIGRhdGUgaXMgbm90IHRvbyBmYXIgaW4gdGhlIHBhc3QgKGNoZWNrIGZpcnN0IEFQT0QgZGF0ZSlcclxuICAgIHZhciBjdXJyZW50RGF0ZSA9IGFwb2RWaWV3TW9kZWwuZ2V0KFwic2VsZWN0ZWREYXRlXCIpO1xyXG4gICAgY3VycmVudERhdGUuc2V0RGF0ZShjdXJyZW50RGF0ZS5nZXREYXRlKCkgLSAxKTtcclxuICAgIGFwb2RWaWV3TW9kZWwuc2V0KFwic2VsZWN0ZWREYXRlXCIsIGN1cnJlbnREYXRlKTtcclxuICAgIGFwb2RWaWV3TW9kZWwuaW5pdERhdGFJdGVtcyhmb3JtYXR0ZXJzLmZvcm1hdERhdGUoY3VycmVudERhdGUpKS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQgJiYgKGFwb2RWaWV3TW9kZWwuZ2V0KFwiZGF0YUl0ZW1cIikubWVkaWFfdHlwZSA9PT0gXCJ2aWRlb1wiKSkge1xyXG4gICAgICAgICAgICBpbml0UGxheWVyKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcGxheWVyLnBhdXNlKCk7XHJcbiAgICAgICAgICAgIGFwb2RWaWV3TW9kZWwuc2V0KFwiaXNQbGF5ZXJWaXNpYmxlXCIsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG5leHREYXRlKCkge1xyXG4gICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcclxuICAgICAgICBzZXRCdXR0b25zT3BhY2l0eSgwLjIpO1xyXG4gICAgICAgIHNldFVzZXJJbnRlcmFjdGlvbihmYWxzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIGN1cnJlbnREYXRlID0gYXBvZFZpZXdNb2RlbC5nZXQoXCJzZWxlY3RlZERhdGVcIik7XHJcbiAgICBpZiAoY3VycmVudERhdGUgPj0gbmV3IERhdGUoKSkge1xyXG4gICAgICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XHJcbiAgICAgICAgICAgIHRvYXN0Lm1ha2VUZXh0KFwiQ2FuIG5vdCBsb2FkIHBob3RvcyBmcm9tIHRoZSBmdXR1cmUhXCIpLnNob3coKTtcclxuICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGN1cnJlbnREYXRlLnNldERhdGUoY3VycmVudERhdGUuZ2V0RGF0ZSgpICsgMSk7XHJcbiAgICAgICAgYXBvZFZpZXdNb2RlbC5zZXQoXCJzZWxlY3RlZERhdGVcIiwgY3VycmVudERhdGUpO1xyXG4gICAgICAgIGFwb2RWaWV3TW9kZWwuaW5pdERhdGFJdGVtcyhmb3JtYXR0ZXJzLmZvcm1hdERhdGUoY3VycmVudERhdGUpKS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkICYmIChhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLm1lZGlhX3R5cGUgPT09IFwidmlkZW9cIikpIHtcclxuICAgICAgICAgICAgICAgIGluaXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBsYXllci5wYXVzZSgpO1xyXG4gICAgICAgICAgICAgICAgYXBvZFZpZXdNb2RlbC5zZXQoXCJpc1BsYXllclZpc2libGVcIiwgZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldEN1cnJlbnRJbWFnZShpbWFnZVVyaTpzdHJpbmcpOiBJbWFnZVNvdXJjZSB7XHJcbiAgICAvLyBva2h0dHAgaXMgYmxvY2tpbmcgc28gbm8gbmVlZCB0byByZXR1cm4gUHJvbWlzZSFcclxuICAgIHZhciBpbnB1dFN0cmVhbSA9IG9rSHR0cC5nZXRJbWFnZShpbWFnZVVyaSk7IFxyXG4gICAgdmFyIGltYWdlID0gaW1hZ2VTb3VyY2UuZnJvbURhdGEoaW5wdXRTdHJlYW0pO1xyXG5cclxuICAgIHJldHVybiBpbWFnZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uRmluYWxJbWFnZVNldChhcmdzOiBGaW5hbEV2ZW50RGF0YSkge1xyXG4gICAgdmFyIGRyYXdlZSA9IGFyZ3Mub2JqZWN0IGFzIEZyZXNjb0RyYXdlZTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhcImRyYXdlZS5pbWFnZVVyaTpcIiArIGRyYXdlZS5pbWFnZVVyaSk7XHJcbiAgICBjb25zb2xlLmxvZyhcImFwb2RWaWV3TW9kZWw6IFwiICsgYXBvZFZpZXdNb2RlbC5nZXQoXCJkYXRhSXRlbVwiKS51cmwpXHJcblxyXG4gICAgY3VycmVudEltYWdlID0gc2V0Q3VycmVudEltYWdlKGRyYXdlZS5pbWFnZVVyaSk7XHJcblxyXG4gICAgc2F2ZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC4yLCByb3RhdGU6IDM2MCB9KVxyXG4gICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIHNhdmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuNSwgcm90YXRlOiAxODAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pXHJcbiAgICAgICAgLnRoZW4oKCkgPT4geyByZXR1cm4gc2F2ZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMS4wLCByb3RhdGU6IDAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pO1xyXG5cclxuICAgIGRlc2t0b3BCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuMiwgcm90YXRlOiAzNjAgfSlcclxuICAgICAgICAudGhlbigoKSA9PiB7IHJldHVybiBkZXNrdG9wQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAwLjUsIHJvdGF0ZTogMTgwLCBkdXJhdGlvbjogMTUwIH0pOyB9KVxyXG4gICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIGRlc2t0b3BCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDEuMCwgcm90YXRlOiAwLCBkdXJhdGlvbjogMTUwIH0pOyB9KTtcclxuXHJcbiAgICBzaGFyZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC4yLCByb3RhdGU6IDM2MCB9KVxyXG4gICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIHNoYXJlQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAwLjUsIHJvdGF0ZTogMTgwLCBkdXJhdGlvbjogMTUwIH0pOyB9KVxyXG4gICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIHNoYXJlQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAxLjAsIHJvdGF0ZTogMCwgZHVyYXRpb246IDE1MCB9KTsgfSlcclxuICAgICAgICAudGhlbigoKSA9PiB7IHNldFVzZXJJbnRlcmFjdGlvbih0cnVlKSB9KVxyXG5cclxuXHJcbiAgICAvLyB0aGlzIG9uZSBpcyByZXR1cm5pbnQgUmVzcG9uc2UgY2Fubm90IGJlIHJlc29sdmVkIGFzIGltYWdlIGluIHtOfSAyLjQuMlxyXG4gICAgLy8gaW1hZ2VTb3VyY2UuZnJvbVVybChkcmF3ZWUuaW1hZ2VVcmkpXHJcbiAgICAvLyAgICAgLnRoZW4ocmVzID0+IHtcclxuICAgIC8vICAgICAgICAgY3VycmVudEltYWdlID0gcmVzO1xyXG5cclxuICAgIC8vICAgICAgICAgc2F2ZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC4yLCByb3RhdGU6IDM2MCB9KVxyXG4gICAgLy8gICAgICAgICAgICAgLnRoZW4oKCkgPT4geyByZXR1cm4gc2F2ZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC41LCByb3RhdGU6IDE4MCwgZHVyYXRpb246IDE1MCB9KTsgfSlcclxuICAgIC8vICAgICAgICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIHNhdmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDEuMCwgcm90YXRlOiAwLCBkdXJhdGlvbjogMTUwIH0pOyB9KTtcclxuXHJcbiAgICAvLyAgICAgICAgIGRlc2t0b3BCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuMiwgcm90YXRlOiAzNjAgfSlcclxuICAgIC8vICAgICAgICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIGRlc2t0b3BCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuNSwgcm90YXRlOiAxODAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pXHJcbiAgICAvLyAgICAgICAgICAgICAudGhlbigoKSA9PiB7IHJldHVybiBkZXNrdG9wQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAxLjAsIHJvdGF0ZTogMCwgZHVyYXRpb246IDE1MCB9KTsgfSk7XHJcblxyXG4gICAgLy8gICAgICAgICBzaGFyZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC4yLCByb3RhdGU6IDM2MCB9KVxyXG4gICAgLy8gICAgICAgICAgICAgLnRoZW4oKCkgPT4geyByZXR1cm4gc2hhcmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuNSwgcm90YXRlOiAxODAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pXHJcbiAgICAvLyAgICAgICAgICAgICAudGhlbigoKSA9PiB7IHJldHVybiBzaGFyZUJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMS4wLCByb3RhdGU6IDAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pO1xyXG5cclxuICAgIC8vICAgICAgICAgc2V0VXNlckludGVyYWN0aW9uKHRydWUpO1xyXG5cclxuICAgIC8vICAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgLy8gICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgLy8gICAgIH0pO1xyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gc2V0VXNlckludGVyYWN0aW9uKHN0YXRlOiBib29sZWFuKSB7XHJcbiAgICBzaGFyZUJ1dHRvbi5pc1VzZXJJbnRlcmFjdGlvbkVuYWJsZWQgPSBzdGF0ZTtcclxuICAgIHNhdmVCdXR0b24uaXNVc2VySW50ZXJhY3Rpb25FbmFibGVkID0gc3RhdGU7XHJcbiAgICBkZXNrdG9wQnV0dG9uLmlzVXNlckludGVyYWN0aW9uRW5hYmxlZCA9IHN0YXRlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRCdXR0b25zT3BhY2l0eSh2YWx1ZTogbnVtYmVyKSB7XHJcbiAgICBzYXZlQnV0dG9uLm9wYWNpdHkgPSB2YWx1ZTtcclxuICAgIGRlc2t0b3BCdXR0b24ub3BhY2l0eSA9IHZhbHVlO1xyXG4gICAgc2hhcmVCdXR0b24ub3BhY2l0eSA9IHZhbHVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzYXZlRmlsZShyZXM6IGltYWdlU291cmNlLkltYWdlU291cmNlKSB7XHJcbiAgICB2YXIgdXJsID0gYXBvZFZpZXdNb2RlbC5nZXQoXCJkYXRhSXRlbVwiKS51cmw7XHJcbiAgICB2YXIgZmlsZU5hbWUgPSB1cmwuc3Vic3RyaW5nKHVybC5sYXN0SW5kZXhPZihcIi9cIikgKyAxKTtcclxuICAgIHZhciBuID0gZmlsZU5hbWUuaW5kZXhPZihcIi5cIik7XHJcbiAgICBmaWxlTmFtZSA9IGZpbGVOYW1lLnN1YnN0cmluZygwLCBuICE9PSAtMSA/IG4gOiBmaWxlTmFtZS5sZW5ndGgpICsgXCIuanBlZ1wiO1xyXG5cclxuICAgIHZhciBjb3Ntb3NGb2xkZXJQYXRoO1xyXG4gICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcclxuICAgICAgICB2YXIgYW5kcm9pZERvd25sb2Fkc1BhdGggPSBhbmRyb2lkLm9zLkVudmlyb25tZW50LmdldEV4dGVybmFsU3RvcmFnZVB1YmxpY0RpcmVjdG9yeShcclxuICAgICAgICAgICAgYW5kcm9pZC5vcy5FbnZpcm9ubWVudC5ESVJFQ1RPUllfRE9XTkxPQURTKS50b1N0cmluZygpO1xyXG4gICAgICAgIGNvc21vc0ZvbGRlclBhdGggPSBmaWxlU3lzdGVtLnBhdGguam9pbihhbmRyb2lkRG93bmxvYWRzUGF0aCwgXCJDb3Ntb3NEYXRhQmFua1wiKTtcclxuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uaW9zKSB7XHJcbiAgICAgICAgLy8gVE9ETyA6ICB0aGlzIHdvcmtzIC0gYnV0IHdoZXJlIGFyZSB0aGUgaW1hZ2VzID9cclxuICAgICAgICB2YXIgaW9zRG93bmxvYWRQYXRoID0gZmlsZVN5c3RlbS5rbm93bkZvbGRlcnMuZG9jdW1lbnRzKCk7XHJcbiAgICAgICAgY29zbW9zRm9sZGVyUGF0aCA9IGZpbGVTeXN0ZW0ucGF0aC5qb2luKGlvc0Rvd25sb2FkUGF0aC5wYXRoLCBcIkNvc21vc0RhdGFCYW5rXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBmb2xkZXIgPSBmaWxlU3lzdGVtLkZvbGRlci5mcm9tUGF0aChjb3Ntb3NGb2xkZXJQYXRoKTtcclxuICAgIHZhciBwYXRoID0gZmlsZVN5c3RlbS5wYXRoLmpvaW4oY29zbW9zRm9sZGVyUGF0aCwgZmlsZU5hbWUpO1xyXG4gICAgdmFyIGV4aXN0cyA9IGZpbGVTeXN0ZW0uRmlsZS5leGlzdHMocGF0aCk7XHJcblxyXG4gICAgaWYgKCFleGlzdHMpIHtcclxuICAgICAgICB2YXIgc2F2ZWQgPSByZXMuc2F2ZVRvRmlsZShwYXRoLCBlbnVtcy5JbWFnZUZvcm1hdC5qcGVnKTtcclxuICAgIH1cclxuXHJcbiAgICBjdXJyZW50U2F2ZWRQYXRoID0gcGF0aDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uU2F2ZUltYWdlKGFyZ3M6IEV2ZW50RGF0YSkge1xyXG5cclxuICAgIGlmIChhcHBsaWNhdGlvbi5pb3MpIHtcclxuICAgICAgICBpbWFnZVNvdXJjZS5mcm9tVXJsKGlvc0ltYWdlLnNyYylcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgICAgIHNhdmVGaWxlKHJlcyk7XHJcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xyXG4gICAgICAgIHNhdmVGaWxlKGN1cnJlbnRJbWFnZSk7XHJcbiAgICAgICAgdG9hc3QubWFrZVRleHQoXCJQaG90byBzYXZlZCBpbiAvRG93bmxvYWRzL0Nvc21vc0RhdGFCYW5rL1wiKS5zaG93KCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvblNldFdhbGxwYXBlcihhcmdzOiBFdmVudERhdGEpIHtcclxuXHJcbiAgICBpZiAoYXBwbGljYXRpb24uaW9zKSB7XHJcbiAgICAgICAgaW1hZ2VTb3VyY2UuZnJvbVVybChpb3NJbWFnZS5zcmMpXHJcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50SW1hZ2UgPSByZXM7IC8vIFRPRE8gOiBzZXQgd2FsbHBhcGVyIGZvciBpT1NcclxuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgIH0pOztcclxuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xyXG4gICAgICAgIHNhdmVGaWxlKGN1cnJlbnRJbWFnZSk7XHJcblxyXG4gICAgICAgIHZhciB3YWxscGFwZXJNYW5hZ2VyID0gYW5kcm9pZC5hcHAuV2FsbHBhcGVyTWFuYWdlci5nZXRJbnN0YW5jZSh1dGlscy5hZC5nZXRBcHBsaWNhdGlvbkNvbnRleHQoKSk7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdmFyIGltYWdlVG9TZXQgPSBpbWFnZVNvdXJjZS5mcm9tRmlsZShjdXJyZW50U2F2ZWRQYXRoKTtcclxuICAgICAgICAgICAgd2FsbHBhcGVyTWFuYWdlci5zZXRCaXRtYXAoaW1hZ2VUb1NldC5hbmRyb2lkKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlcnJvcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0b2FzdC5tYWtlVGV4dChcIldhbGxwYXBlciBTZXQhXCIpLnNob3coKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uU2hhcmUoYXJnczogRXZlbnREYXRhKSB7XHJcbiAgICBmaXJlYmFzZS5wdXNoKFxyXG4gICAgICAgIFwiL2Zhdm9yaXRlc1wiLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgXCJkYXRhSXRlbVwiOiBhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLFxyXG4gICAgICAgICAgICBcInVwZGF0ZVRzXCI6IGZpcmViYXNlW1wiU2VydmVyVmFsdWVcIl0uVElNRVNUQU1QXHJcbiAgICAgICAgfVxyXG4gICAgKS50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJjcmVhdGVkIGtleTogXCIgKyByZXN1bHQua2V5KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XHJcbiAgICAgICAgU29jaWFsU2hhcmUuc2hhcmVJbWFnZShjdXJyZW50SW1hZ2UsIFwiTkFTQSBBUE9EXCIpO1xyXG4gICAgfSBlbHNlIGlmIChhcHBsaWNhdGlvbi5pb3MpIHtcclxuICAgICAgICBpbWFnZVNvdXJjZS5mcm9tVXJsKGlvc0ltYWdlLnNyYylcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgICAgIFNvY2lhbFNoYXJlLnNoYXJlSW1hZ2UocmVzKTtcclxuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0UGxheWVyKCkge1xyXG4gICAgdmFyIG1lZGlhVXJsID0gYXBvZFZpZXdNb2RlbC5nZXQoXCJkYXRhSXRlbVwiKS51cmw7XHJcblxyXG4gICAgaWYgKG1lZGlhVXJsLmluZGV4T2YoXCJ5b3V0dWJlXCIpID49IDApIHtcclxuICAgICAgICBhcG9kVmlld01vZGVsLnNldChcImlzUGxheWVyVmlzaWJsZVwiLCB0cnVlKTtcclxuICAgICAgICB2YXIgeW91dHViZUlEID0geW91dHViZUhlbHBlcnMuZ2V0WW91VHViZUlEKG1lZGlhVXJsKTtcclxuICAgICAgICBwbGF5ZXIubG9hZFZpZGVvKHlvdXR1YmVJRCwgMTApOyAvLyBwYXNzIHRoZSBhY3R1YWwgdmlkZW8gaGVyZSBvciBsb2FkIHdlYi12aWV3XHJcbiAgICAgICAgcGxheWVyLnBsYXkoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcGxheWVyLnBhdXNlKCk7XHJcbiAgICAgICAgYXBvZFZpZXdNb2RlbC5zZXQoXCJpc1BsYXllclZpc2libGVcIiwgZmFsc2UpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==