"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var application = require("application");
var imageSource = require("image-source");
var utils = require("utils/utils");
var SocialShare = require("nativescript-social-share");
var youtubeHelpers = require("../helpers/youtube/youtube-helpers");
var formatters = require("../helpers/formaters");
var file_helpers_1 = require("../helpers/files/file-helpers");
var firebase_1 = require("../helpers/firebase/firebase");
// Android app only 
var toast = require("nativescript-toast");
// models, view-models, credentials
var credentials_1 = require("../../files/credentials");
var apod_model_1 = require("../../view-models/apod/apod-model");
var apodViewModel = new apod_model_1.ApodViewModel();
apodViewModel.set("isPlayerVisible", false);
apodViewModel.set("youtube_api_key", credentials_1.YOUTUBE_API_KEY);
apodViewModel.set("youtube_video_key", "2zNSgSzhBfM");
var page;
var shareButton;
var saveButton;
var desktopButton;
var iosImage;
var currentImage;
var currentSavedPath;
var player;
function onPageLoaded(args) {
    page = args.object;
}
exports.onPageLoaded = onPageLoaded;
function onScrollSwipe(args) {
    if (args.direction === 1) {
        previousDate();
    }
    else if (args.direction === 2) {
        nextDate();
    }
}
exports.onScrollSwipe = onScrollSwipe;
function onPageNavigatedTo(args) {
    page = args.object;
    shareButton = page.getViewById("btn-shar");
    saveButton = page.getViewById("btn-save");
    desktopButton = page.getViewById("btn-desk");
    if (application.android) {
        player = page.getViewById("player");
        file_helpers_1.setButtonsOpacity(shareButton, saveButton, desktopButton, 0.2);
        file_helpers_1.setUserInteraction(shareButton, saveButton, desktopButton, false);
    }
    if (application.ios) {
        iosImage = page.getViewById("ios-image");
    }
    if (!apodViewModel.get("dataItem")) {
        apodViewModel.initDataItems().then(function (res) {
            console.log(apodViewModel.get("dataItem").media_type === "video");
            if (application.android && (apodViewModel.get("dataItem").media_type === "video")) {
                initPlayer();
            }
            else {
                player.pause();
                apodViewModel.set("isPlayerVisible", false);
            }
        });
    }
    page.bindingContext = apodViewModel;
}
exports.onPageNavigatedTo = onPageNavigatedTo;
function previousDate() {
    if (application.android) {
        file_helpers_1.setButtonsOpacity(shareButton, saveButton, desktopButton, 0.2);
        file_helpers_1.setUserInteraction(shareButton, saveButton, desktopButton, false);
    }
    // TODO: add check if the date is not too far in the past (check first APOD date)
    var currentDate = apodViewModel.get("selectedDate");
    currentDate.setDate(currentDate.getDate() - 1);
    apodViewModel.set("selectedDate", currentDate);
    apodViewModel.initDataItems(formatters.formatDate(currentDate)).then(function (res) {
        if (application.android && (apodViewModel.get("dataItem").media_type === "video")) {
            initPlayer();
        }
        else {
            player.pause();
            apodViewModel.set("isPlayerVisible", false);
        }
    });
}
exports.previousDate = previousDate;
function nextDate() {
    if (application.android) {
        file_helpers_1.setButtonsOpacity(shareButton, saveButton, desktopButton, 0.2);
        file_helpers_1.setUserInteraction(shareButton, saveButton, desktopButton, false);
    }
    var currentDate = apodViewModel.get("selectedDate");
    if (currentDate >= new Date()) {
        if (application.android) {
            toast.makeText("Can not load photos from the future!").show();
        }
    }
    else {
        currentDate.setDate(currentDate.getDate() + 1);
        apodViewModel.set("selectedDate", currentDate);
        apodViewModel.initDataItems(formatters.formatDate(currentDate)).then(function (res) {
            if (application.android && (apodViewModel.get("dataItem").media_type === "video")) {
                initPlayer();
            }
            else {
                player.pause();
                apodViewModel.set("isPlayerVisible", false);
            }
        });
    }
}
exports.nextDate = nextDate;
function onFinalImageSet(args) {
    console.log("onFinalImageSet");
    var drawee = args.object;
    currentImage = file_helpers_1.setCurrentImage(drawee.imageUri);
    saveButton.animate({ opacity: 0.2, rotate: 360 })
        .then(function () { return saveButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
        .then(function () { return saveButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
    desktopButton.animate({ opacity: 0.2, rotate: 360 })
        .then(function () { return desktopButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
        .then(function () { return desktopButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); });
    shareButton.animate({ opacity: 0.2, rotate: 360 })
        .then(function () { return shareButton.animate({ opacity: 0.5, rotate: 180, duration: 150 }); })
        .then(function () { return shareButton.animate({ opacity: 1.0, rotate: 0, duration: 150 }); })
        .then(function () { file_helpers_1.setUserInteraction(shareButton, saveButton, desktopButton, true); });
}
exports.onFinalImageSet = onFinalImageSet;
function onSaveImage(args) {
    firebase_1.firebasePush(apodViewModel.get("dataItem"), "save");
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            file_helpers_1.saveFile(res, apodViewModel.get("dataItem").url, currentSavedPath);
        }).catch(function (err) {
            console.log(err);
        });
    }
    else if (application.android) {
        file_helpers_1.saveFile(currentImage, apodViewModel.get("dataItem").url, currentSavedPath);
        toast.makeText("Photo saved in /Downloads/CosmosDataBank/").show();
    }
}
exports.onSaveImage = onSaveImage;
function onSetWallpaper(args) {
    firebase_1.firebasePush(apodViewModel.get("dataItem"), "wallpaper");
    if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            currentImage = res; // TODO : set wallpaper for iOS
        }).catch(function (err) {
            console.log(err);
        });
        ;
    }
    else if (application.android) {
        file_helpers_1.saveFile(currentImage, apodViewModel.get("dataItem").url, currentSavedPath);
        var wallpaperManager = application.android.nativeApp.app.WallpaperManager.getInstance(utils.ad.getApplicationContext());
        try {
            wallpaperManager.setBitmap(currentImage.android);
        }
        catch (error) {
            console.log(error);
        }
        toast.makeText("Wallpaper Set!").show();
    }
}
exports.onSetWallpaper = onSetWallpaper;
function onShare(args) {
    firebase_1.firebasePush(apodViewModel.get("dataItem"), "share");
    if (application.android) {
        SocialShare.shareImage(currentImage, "NASA APOD");
    }
    else if (application.ios) {
        imageSource.fromUrl(iosImage.src)
            .then(function (res) {
            SocialShare.shareImage(res);
        }).catch(function (err) {
            console.log(err);
        });
    }
}
exports.onShare = onShare;
function initPlayer() {
    var mediaUrl = apodViewModel.get("dataItem").url;
    if (mediaUrl.indexOf("youtube") >= 0) {
        apodViewModel.set("isPlayerVisible", true);
        var youtubeID = youtubeHelpers.getYouTubeID(mediaUrl);
        player.loadVideo(youtubeID, 10); // pass the actual video here or load web-view
        player.play();
    }
    else {
        player.pause();
        apodViewModel.set("isPlayerVisible", false);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBvZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwb2QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFLQSx5Q0FBNEM7QUFDNUMsMENBQTZDO0FBQzdDLG1DQUFxQztBQUdyQyx1REFBeUQ7QUFFekQsbUVBQXFFO0FBQ3JFLGlEQUFtRDtBQUNuRCw4REFBaUg7QUFDakgseURBQTREO0FBRTVELG9CQUFvQjtBQUNwQiwwQ0FBNEM7QUFHNUMsbUNBQW1DO0FBQ25DLHVEQUEwRDtBQUMxRCxnRUFBa0U7QUFFbEUsSUFBSSxhQUFhLEdBQUcsSUFBSSwwQkFBYSxFQUFFLENBQUM7QUFDeEMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM1QyxhQUFhLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLDZCQUFlLENBQUMsQ0FBQztBQUN0RCxhQUFhLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBRXRELElBQUksSUFBVSxDQUFDO0FBQ2YsSUFBSSxXQUFtQixDQUFDO0FBQ3hCLElBQUksVUFBa0IsQ0FBQztBQUN2QixJQUFJLGFBQXFCLENBQUM7QUFDMUIsSUFBSSxRQUFlLENBQUM7QUFDcEIsSUFBSSxZQUFxQyxDQUFDO0FBRTFDLElBQUksZ0JBQXdCLENBQUM7QUFDN0IsSUFBSSxNQUFNLENBQUM7QUFFWCxzQkFBNkIsSUFBZTtJQUN4QyxJQUFJLEdBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUM3QixDQUFDO0FBRkQsb0NBRUM7QUFFRCx1QkFBOEIsSUFBMkI7SUFDckQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLFlBQVksRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLFFB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LENBQUM7QUFkRCwwQkFjQztBQUVEO0lBQ0ksSUFBSSxRQUFRLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUM7SUFFakQsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25DLGFBQWEsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0MsSUFBSSxTQUFTLEdBQUcsY0FBYyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RCxNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLDhDQUE4QztRQUMvRSxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ0osTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsYUFBYSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNoRCxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RGF0YSB9IGZyb20gXCJkYXRhL29ic2VydmFibGVcIjtcbmltcG9ydCB7IEJ1dHRvbiB9IGZyb20gXCJ1aS9idXR0b25cIjtcbmltcG9ydCB7IEltYWdlIH0gZnJvbSBcInVpL2ltYWdlXCI7XG5pbXBvcnQgeyBHZXN0dXJlVHlwZXMsIFN3aXBlR2VzdHVyZUV2ZW50RGF0YSB9IGZyb20gXCJ1aS9nZXN0dXJlc1wiO1xuaW1wb3J0IHsgUGFnZSB9IGZyb20gXCJ1aS9wYWdlXCI7XG5pbXBvcnQgYXBwbGljYXRpb24gPSByZXF1aXJlKFwiYXBwbGljYXRpb25cIik7XG5pbXBvcnQgaW1hZ2VTb3VyY2UgPSByZXF1aXJlKFwiaW1hZ2Utc291cmNlXCIpO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSBcInV0aWxzL3V0aWxzXCI7XG5cbmltcG9ydCB7IEZyZXNjb0RyYXdlZSwgRmluYWxFdmVudERhdGEgfSBmcm9tIFwibmF0aXZlc2NyaXB0LWZyZXNjb1wiO1xuaW1wb3J0ICogYXMgU29jaWFsU2hhcmUgZnJvbSBcIm5hdGl2ZXNjcmlwdC1zb2NpYWwtc2hhcmVcIjtcblxuaW1wb3J0ICogYXMgeW91dHViZUhlbHBlcnMgZnJvbSBcIi4uL2hlbHBlcnMveW91dHViZS95b3V0dWJlLWhlbHBlcnNcIjtcbmltcG9ydCAqIGFzIGZvcm1hdHRlcnMgZnJvbSBcIi4uL2hlbHBlcnMvZm9ybWF0ZXJzXCI7XG5pbXBvcnQgeyBzYXZlRmlsZSwgc2V0QnV0dG9uc09wYWNpdHksIHNldFVzZXJJbnRlcmFjdGlvbiwgc2V0Q3VycmVudEltYWdlIH0gZnJvbSBcIi4uL2hlbHBlcnMvZmlsZXMvZmlsZS1oZWxwZXJzXCI7XG5pbXBvcnQgeyBmaXJlYmFzZVB1c2ggfSBmcm9tIFwiLi4vaGVscGVycy9maXJlYmFzZS9maXJlYmFzZVwiO1xuXG4vLyBBbmRyb2lkIGFwcCBvbmx5IFxuaW1wb3J0ICogYXMgdG9hc3QgZnJvbSBcIm5hdGl2ZXNjcmlwdC10b2FzdFwiO1xuXG5cbi8vIG1vZGVscywgdmlldy1tb2RlbHMsIGNyZWRlbnRpYWxzXG5pbXBvcnQgeyBZT1VUVUJFX0FQSV9LRVkgfSBmcm9tIFwiLi4vLi4vZmlsZXMvY3JlZGVudGlhbHNcIjtcbmltcG9ydCB7IEFwb2RWaWV3TW9kZWwgfSBmcm9tIFwiLi4vLi4vdmlldy1tb2RlbHMvYXBvZC9hcG9kLW1vZGVsXCI7XG5cbmxldCBhcG9kVmlld01vZGVsID0gbmV3IEFwb2RWaWV3TW9kZWwoKTtcbmFwb2RWaWV3TW9kZWwuc2V0KFwiaXNQbGF5ZXJWaXNpYmxlXCIsIGZhbHNlKTtcbmFwb2RWaWV3TW9kZWwuc2V0KFwieW91dHViZV9hcGlfa2V5XCIsIFlPVVRVQkVfQVBJX0tFWSk7XG5hcG9kVmlld01vZGVsLnNldChcInlvdXR1YmVfdmlkZW9fa2V5XCIsIFwiMnpOU2dTemhCZk1cIik7XG5cbmxldCBwYWdlOiBQYWdlO1xubGV0IHNoYXJlQnV0dG9uOiBCdXR0b247XG5sZXQgc2F2ZUJ1dHRvbjogQnV0dG9uO1xubGV0IGRlc2t0b3BCdXR0b246IEJ1dHRvbjtcbmxldCBpb3NJbWFnZTogSW1hZ2U7XG5sZXQgY3VycmVudEltYWdlOiBpbWFnZVNvdXJjZS5JbWFnZVNvdXJjZTtcblxudmFyIGN1cnJlbnRTYXZlZFBhdGg6IHN0cmluZztcbmxldCBwbGF5ZXI7XG5cbmV4cG9ydCBmdW5jdGlvbiBvblBhZ2VMb2FkZWQoYXJnczogRXZlbnREYXRhKSB7XG4gICAgcGFnZSA9IDxQYWdlPmFyZ3Mub2JqZWN0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb25TY3JvbGxTd2lwZShhcmdzOiBTd2lwZUdlc3R1cmVFdmVudERhdGEpIHtcbiAgICBpZiAoYXJncy5kaXJlY3Rpb24gPT09IDEpIHtcbiAgICAgICAgcHJldmlvdXNEYXRlKCk7XG4gICAgfSBlbHNlIGlmIChhcmdzLmRpcmVjdGlvbiA9PT0gMikge1xuICAgICAgICBuZXh0RGF0ZSgpO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9uUGFnZU5hdmlnYXRlZFRvKGFyZ3M6IEV2ZW50RGF0YSkge1xuICAgIHBhZ2UgPSA8UGFnZT5hcmdzLm9iamVjdDtcblxuICAgIHNoYXJlQnV0dG9uID0gPEJ1dHRvbj5wYWdlLmdldFZpZXdCeUlkKFwiYnRuLXNoYXJcIik7XG4gICAgc2F2ZUJ1dHRvbiA9IDxCdXR0b24+cGFnZS5nZXRWaWV3QnlJZChcImJ0bi1zYXZlXCIpO1xuICAgIGRlc2t0b3BCdXR0b24gPSA8QnV0dG9uPnBhZ2UuZ2V0Vmlld0J5SWQoXCJidG4tZGVza1wiKTtcblxuICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XG4gICAgICAgIHBsYXllciA9IHBhZ2UuZ2V0Vmlld0J5SWQoXCJwbGF5ZXJcIik7XG4gICAgICAgIHNldEJ1dHRvbnNPcGFjaXR5KHNoYXJlQnV0dG9uLCBzYXZlQnV0dG9uLCBkZXNrdG9wQnV0dG9uLCAwLjIpO1xuICAgICAgICBzZXRVc2VySW50ZXJhY3Rpb24oc2hhcmVCdXR0b24sIHNhdmVCdXR0b24sIGRlc2t0b3BCdXR0b24sIGZhbHNlKTtcbiAgICB9XG5cbiAgICBpZiAoYXBwbGljYXRpb24uaW9zKSB7XG4gICAgICAgIGlvc0ltYWdlID0gPEltYWdlPnBhZ2UuZ2V0Vmlld0J5SWQoXCJpb3MtaW1hZ2VcIik7XG4gICAgfVxuXG4gICAgaWYgKCFhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpKSB7XG4gICAgICAgIGFwb2RWaWV3TW9kZWwuaW5pdERhdGFJdGVtcygpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGFwb2RWaWV3TW9kZWwuZ2V0KFwiZGF0YUl0ZW1cIikubWVkaWFfdHlwZSA9PT0gXCJ2aWRlb1wiKTtcbiAgICAgICAgICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkICYmIChhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLm1lZGlhX3R5cGUgPT09IFwidmlkZW9cIikpIHtcbiAgICAgICAgICAgICAgICBpbml0UGxheWVyKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBsYXllci5wYXVzZSgpO1xuICAgICAgICAgICAgICAgIGFwb2RWaWV3TW9kZWwuc2V0KFwiaXNQbGF5ZXJWaXNpYmxlXCIsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcGFnZS5iaW5kaW5nQ29udGV4dCA9IGFwb2RWaWV3TW9kZWw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmV2aW91c0RhdGUoKSB7XG4gICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcbiAgICAgICAgc2V0QnV0dG9uc09wYWNpdHkoc2hhcmVCdXR0b24sIHNhdmVCdXR0b24sIGRlc2t0b3BCdXR0b24sIDAuMik7XG4gICAgICAgIHNldFVzZXJJbnRlcmFjdGlvbihzaGFyZUJ1dHRvbiwgc2F2ZUJ1dHRvbiwgZGVza3RvcEJ1dHRvbiwgZmFsc2UpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IGFkZCBjaGVjayBpZiB0aGUgZGF0ZSBpcyBub3QgdG9vIGZhciBpbiB0aGUgcGFzdCAoY2hlY2sgZmlyc3QgQVBPRCBkYXRlKVxuICAgIHZhciBjdXJyZW50RGF0ZSA9IGFwb2RWaWV3TW9kZWwuZ2V0KFwic2VsZWN0ZWREYXRlXCIpO1xuICAgIGN1cnJlbnREYXRlLnNldERhdGUoY3VycmVudERhdGUuZ2V0RGF0ZSgpIC0gMSk7XG4gICAgYXBvZFZpZXdNb2RlbC5zZXQoXCJzZWxlY3RlZERhdGVcIiwgY3VycmVudERhdGUpO1xuICAgIGFwb2RWaWV3TW9kZWwuaW5pdERhdGFJdGVtcyhmb3JtYXR0ZXJzLmZvcm1hdERhdGUoY3VycmVudERhdGUpKS50aGVuKHJlcyA9PiB7XG4gICAgICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkICYmIChhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLm1lZGlhX3R5cGUgPT09IFwidmlkZW9cIikpIHtcbiAgICAgICAgICAgIGluaXRQbGF5ZXIoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBsYXllci5wYXVzZSgpO1xuICAgICAgICAgICAgYXBvZFZpZXdNb2RlbC5zZXQoXCJpc1BsYXllclZpc2libGVcIiwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuZXh0RGF0ZSgpIHtcbiAgICBpZiAoYXBwbGljYXRpb24uYW5kcm9pZCkge1xuICAgICAgICBzZXRCdXR0b25zT3BhY2l0eShzaGFyZUJ1dHRvbiwgc2F2ZUJ1dHRvbiwgZGVza3RvcEJ1dHRvbiwgMC4yKTtcbiAgICAgICAgc2V0VXNlckludGVyYWN0aW9uKHNoYXJlQnV0dG9uLCBzYXZlQnV0dG9uLCBkZXNrdG9wQnV0dG9uLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgdmFyIGN1cnJlbnREYXRlID0gYXBvZFZpZXdNb2RlbC5nZXQoXCJzZWxlY3RlZERhdGVcIik7XG4gICAgaWYgKGN1cnJlbnREYXRlID49IG5ldyBEYXRlKCkpIHtcbiAgICAgICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcbiAgICAgICAgICAgIHRvYXN0Lm1ha2VUZXh0KFwiQ2FuIG5vdCBsb2FkIHBob3RvcyBmcm9tIHRoZSBmdXR1cmUhXCIpLnNob3coKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGN1cnJlbnREYXRlLnNldERhdGUoY3VycmVudERhdGUuZ2V0RGF0ZSgpICsgMSk7XG4gICAgICAgIGFwb2RWaWV3TW9kZWwuc2V0KFwic2VsZWN0ZWREYXRlXCIsIGN1cnJlbnREYXRlKTtcbiAgICAgICAgYXBvZFZpZXdNb2RlbC5pbml0RGF0YUl0ZW1zKGZvcm1hdHRlcnMuZm9ybWF0RGF0ZShjdXJyZW50RGF0ZSkpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkICYmIChhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLm1lZGlhX3R5cGUgPT09IFwidmlkZW9cIikpIHtcbiAgICAgICAgICAgICAgICBpbml0UGxheWVyKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBsYXllci5wYXVzZSgpO1xuICAgICAgICAgICAgICAgIGFwb2RWaWV3TW9kZWwuc2V0KFwiaXNQbGF5ZXJWaXNpYmxlXCIsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gb25GaW5hbEltYWdlU2V0KGFyZ3M6IEZpbmFsRXZlbnREYXRhKSB7XG4gICAgY29uc29sZS5sb2coXCJvbkZpbmFsSW1hZ2VTZXRcIilcbiAgICB2YXIgZHJhd2VlID0gYXJncy5vYmplY3QgYXMgRnJlc2NvRHJhd2VlO1xuXG4gICAgY3VycmVudEltYWdlID0gc2V0Q3VycmVudEltYWdlKGRyYXdlZS5pbWFnZVVyaSk7XG5cbiAgICBzYXZlQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAwLjIsIHJvdGF0ZTogMzYwIH0pXG4gICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIHNhdmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuNSwgcm90YXRlOiAxODAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pXG4gICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIHNhdmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDEuMCwgcm90YXRlOiAwLCBkdXJhdGlvbjogMTUwIH0pOyB9KTtcblxuICAgIGRlc2t0b3BCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuMiwgcm90YXRlOiAzNjAgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4geyByZXR1cm4gZGVza3RvcEJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMC41LCByb3RhdGU6IDE4MCwgZHVyYXRpb246IDE1MCB9KTsgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4geyByZXR1cm4gZGVza3RvcEJ1dHRvbi5hbmltYXRlKHsgb3BhY2l0eTogMS4wLCByb3RhdGU6IDAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pO1xuXG4gICAgc2hhcmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuMiwgcm90YXRlOiAzNjAgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4geyByZXR1cm4gc2hhcmVCdXR0b24uYW5pbWF0ZSh7IG9wYWNpdHk6IDAuNSwgcm90YXRlOiAxODAsIGR1cmF0aW9uOiAxNTAgfSk7IH0pXG4gICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIHNoYXJlQnV0dG9uLmFuaW1hdGUoeyBvcGFjaXR5OiAxLjAsIHJvdGF0ZTogMCwgZHVyYXRpb246IDE1MCB9KTsgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4geyBzZXRVc2VySW50ZXJhY3Rpb24oc2hhcmVCdXR0b24sIHNhdmVCdXR0b24sIGRlc2t0b3BCdXR0b24sIHRydWUpIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb25TYXZlSW1hZ2UoYXJnczogRXZlbnREYXRhKSB7XG5cbiAgICBmaXJlYmFzZVB1c2goYXBvZFZpZXdNb2RlbC5nZXQoXCJkYXRhSXRlbVwiKSwgXCJzYXZlXCIpO1xuXG4gICAgaWYgKGFwcGxpY2F0aW9uLmlvcykge1xuICAgICAgICBpbWFnZVNvdXJjZS5mcm9tVXJsKGlvc0ltYWdlLnNyYylcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgc2F2ZUZpbGUocmVzLCBhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLnVybCwgY3VycmVudFNhdmVkUGF0aCk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcbiAgICAgICAgc2F2ZUZpbGUoY3VycmVudEltYWdlLCBhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLnVybCwgY3VycmVudFNhdmVkUGF0aCk7XG4gICAgICAgIHRvYXN0Lm1ha2VUZXh0KFwiUGhvdG8gc2F2ZWQgaW4gL0Rvd25sb2Fkcy9Db3Ntb3NEYXRhQmFuay9cIikuc2hvdygpO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9uU2V0V2FsbHBhcGVyKGFyZ3M6IEV2ZW50RGF0YSkge1xuXG4gICAgZmlyZWJhc2VQdXNoKGFwb2RWaWV3TW9kZWwuZ2V0KFwiZGF0YUl0ZW1cIiksIFwid2FsbHBhcGVyXCIpO1xuXG4gICAgaWYgKGFwcGxpY2F0aW9uLmlvcykge1xuICAgICAgICBpbWFnZVNvdXJjZS5mcm9tVXJsKGlvc0ltYWdlLnNyYylcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgY3VycmVudEltYWdlID0gcmVzOyAvLyBUT0RPIDogc2V0IHdhbGxwYXBlciBmb3IgaU9TXG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICB9KTs7XG4gICAgfSBlbHNlIGlmIChhcHBsaWNhdGlvbi5hbmRyb2lkKSB7XG4gICAgICAgIHNhdmVGaWxlKGN1cnJlbnRJbWFnZSwgYXBvZFZpZXdNb2RlbC5nZXQoXCJkYXRhSXRlbVwiKS51cmwsIGN1cnJlbnRTYXZlZFBhdGgpO1xuXG4gICAgICAgIHZhciB3YWxscGFwZXJNYW5hZ2VyID0gYXBwbGljYXRpb24uYW5kcm9pZC5uYXRpdmVBcHAuYXBwLldhbGxwYXBlck1hbmFnZXIuZ2V0SW5zdGFuY2UodXRpbHMuYWQuZ2V0QXBwbGljYXRpb25Db250ZXh0KCkpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgd2FsbHBhcGVyTWFuYWdlci5zZXRCaXRtYXAoY3VycmVudEltYWdlLmFuZHJvaWQpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgdG9hc3QubWFrZVRleHQoXCJXYWxscGFwZXIgU2V0IVwiKS5zaG93KCk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gb25TaGFyZShhcmdzOiBFdmVudERhdGEpIHtcblxuICAgIGZpcmViYXNlUHVzaChhcG9kVmlld01vZGVsLmdldChcImRhdGFJdGVtXCIpLCBcInNoYXJlXCIpO1xuXG4gICAgaWYgKGFwcGxpY2F0aW9uLmFuZHJvaWQpIHtcbiAgICAgICAgU29jaWFsU2hhcmUuc2hhcmVJbWFnZShjdXJyZW50SW1hZ2UsIFwiTkFTQSBBUE9EXCIpO1xuICAgIH0gZWxzZSBpZiAoYXBwbGljYXRpb24uaW9zKSB7XG4gICAgICAgIGltYWdlU291cmNlLmZyb21VcmwoaW9zSW1hZ2Uuc3JjKVxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgICAgICBTb2NpYWxTaGFyZS5zaGFyZUltYWdlKHJlcyk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGluaXRQbGF5ZXIoKSB7XG4gICAgdmFyIG1lZGlhVXJsID0gYXBvZFZpZXdNb2RlbC5nZXQoXCJkYXRhSXRlbVwiKS51cmw7XG5cbiAgICBpZiAobWVkaWFVcmwuaW5kZXhPZihcInlvdXR1YmVcIikgPj0gMCkge1xuICAgICAgICBhcG9kVmlld01vZGVsLnNldChcImlzUGxheWVyVmlzaWJsZVwiLCB0cnVlKTtcbiAgICAgICAgdmFyIHlvdXR1YmVJRCA9IHlvdXR1YmVIZWxwZXJzLmdldFlvdVR1YmVJRChtZWRpYVVybCk7XG4gICAgICAgIHBsYXllci5sb2FkVmlkZW8oeW91dHViZUlELCAxMCk7IC8vIHBhc3MgdGhlIGFjdHVhbCB2aWRlbyBoZXJlIG9yIGxvYWQgd2ViLXZpZXdcbiAgICAgICAgcGxheWVyLnBsYXkoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBwbGF5ZXIucGF1c2UoKTtcbiAgICAgICAgYXBvZFZpZXdNb2RlbC5zZXQoXCJpc1BsYXllclZpc2libGVcIiwgZmFsc2UpO1xuICAgIH1cbn1cbiJdfQ==